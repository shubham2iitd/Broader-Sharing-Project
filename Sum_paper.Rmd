
```{r}
library(data.table)
library(readxl)
library(openxlsx)
library(ggplot2)
library(maptools)
library(foreign)
library(dplyr)
library(haven)
library(reshape2)
library(stringr)
```

# Source file (It is the one used for structural model estimation):
```{r}
computer = "imac" # mac, imac, windows

region = "all"    # 2

if (computer == "imac") {
  fol = paste0("/Volumes/GoogleDrive/My Drive/SRTR/R_files/Equilibrium/Input_data/", ifelse(region == "all", "Nation", "Region2"))
  fol_ = "/Volumes/GoogleDrive/My Drive/SRTR"
} else if (computer == "mac") {
  fol = paste0("/Users/shubham/Google Drive/SRTR/R_files/Equilibrium/Input_data/", ifelse(region == "all", "Nation", "Region2"))
  fol_ = "/Users/shubham/Google Drive/SRTR"
} else if (computer == "windows") {
  fol = paste0("C:/Users/sakshat/Google Drive/SRTR/R_files/Equilibrium/Input_data/", ifelse(region == "all", "Nation", "Region2"))
  fol_ = "C:/Users/sakshat/Google Drive/SRTR"
}

df = read.csv(paste0(fol_, "/Analysis/temp_Julia/match_Estm_G6AC_48org_det_waitcost_NoN_after_Y_3RA.csv"), stringsAsFactors = T)
df$date <- as.Date(df$date, format= "%Y-%m-%d")

lst = c("DON_ABO", "DON_NON_HR_BEAT")
for (col in lst) {
  df[, col] = as.character(df[, col])
  df[, col] = gsub("b'", "", df[, col])
  df[, col] = gsub("'", "", df[, col])
}
# names(df)
sort(table(df$CAN_OPO_REGION)/nrow(df))
```

# Logistic regression for accept/decline:
```{r}
if (region == "all") {
  df2 = subset(df, !is.na(CAN_OPO_REGION))
} else if (region == 2) {
  df2 = subset(df, CAN_OPO_REGION == "2")
}

df2$y = 1; df2[df2$PTR_OFFER_ACPT == "N", "y"] = 0
df2 = within(df2, new_PTR_STAT_CD_desp <- relevel(new_PTR_STAT_CD_desp, ref = "MELD/PELD 6-14"))
m = glm(y ~ new_PTR_STAT_CD_desp + policy + rec_age_type + rec_life_sup + rec_med_cond + type, family = "binomial", data = df2)  # PTR_SEQUENCE_NUM_upd
summary(m)
length(coef(m))
# unique(df2$PTR_OFFER_ACPT)
# sum(is.na(df2$PTR_OFFER_ACPT))

```

# AVerage position at offer acceptance:
```{r}
summary(df2[df2$PTR_OFFER_ACPT == "Y", ]$PTR_SEQUENCE_NUM_upd)
nrow(df2) / uniqueN(df2$DONOR_ID)
quantile(df2$PTR_SEQUENCE_NUM_upd, c(0.5, .8, .82, .9, .95, .98, .99, .995))
quantile(df2[df2$PTR_OFFER_ACPT == "Y", ]$PTR_SEQUENCE_NUM_upd, c(0.5, .8, .82, .9, .95, .98, .99, .995))

```

# Adding Blood-compatibility column (Source: Estm_Rust_Cox_det_waitcost.Rmd):
```{r}
ABO_compt = read.csv(paste0(fol_, "/Analysis/ABO_compt.csv"), stringsAsFactors = F)
df2 = merge(df2, ABO_compt, all.x = T)
df2$ABO_compt = df2$MELD_ABO_compt   # table(df2$ABO_compt); sum(is.na(df2$ABO_compt))
cond = df2$PTR_STAT_CD_desp %in% c("Status 1A", "Status 1B")
df2[cond, "ABO_compt"] = df2[cond, "Status_ABO_compt"]; # table(df2$ABO_compt)
cond1 = (df2$ABO_compt == "S") & (!is.na(df2$CAN_ACPT_A2_DON)) & (df2$CAN_ACPT_A2_DON != "N")  # sum(cond1)
cond2 = (df2$ABO_compt == "S") & (!is.na(df2$CAN_ACPT_A2_DON)) & (df2$CAN_ACPT_A2_DON == "N")  # sum(cond2)
df2[cond1, "ABO_compt"] = "C"; df2[cond2, "ABO_compt"] = "X"; # table(df2$ABO_compt)
df2[(df2$ABO_compt == "S"), "ABO_compt"] = "X"   # 71 obs. with "S" do not have 'CAN_ACPT_A2_DON' entry, so assuming them to be "X".
df2 = data.frame(df2)[, -which(colnames(df2) %in% c("Status_ABO_compt", "MELD_ABO_compt"))]
temp = subset(df2, is.na(ABO_compt))    # Because CAN_ABO is not found!, #table(temp$CAN_ABO); table(temp$df2_OPO_CTR_CD)

# Fill the values "I", since 91.4% values are "I" in the data:
df2[is.na(df2$ABO_compt), "ABO_compt"] = "I"
df2$ABO_compt = as.character(df2$ABO_compt)
  
table(df2$ABO_compt)/nrow(df2)
```

# Exploring Waiting list candidates (DEMAND) and donor (SUPPLY):
```{r}
wl = read.csv(paste0(fol_, "/From SRTR/pubsaf1903/cand_liin.csv"), stringsAsFactors = F)
tx = read.csv(paste0(fol_, "/Analysis/tx.csv"), stringsAsFactors = F)
txf = read.csv(paste0(fol_, "/Analysis/txf_recent.csv"), stringsAsFactors = F)
#txf = read.csv(paste0(fol_, "/Analysis/txf_recent.csv"))
don = read.csv(paste0(fol_, "/Analysis/donor.csv"), stringsAsFactors = F)
```

```{r}
wl$list_date = as.Date(wl$CAN_LISTING_DT, format= "%Y-%m-%d")
min(wl$list_date, na.rm = T); max(wl$list_date, na.rm = T)
wl1= wl[!is.na(wl$list_date) & (wl$list_date >= "2010-01-01") & (wl$list_date < "2019-01-01"), ]

wl1$policy = sapply(c(1:nrow(wl1)), function(i) {if (wl1$list_date[i] > "2013-06-17") {return ("post")} else {return ("pre")}}) 

# Linking with INSTITUTION data:
inst = read.csv(paste0(fol_, "/From SRTR/pubsaf1903/institution.csv"), stringsAsFactors = F)
temp = inst[, c("CTR_ID", "CTR_CD", "REGION")]
colnames(temp) = c("CTR_ID", "CAN_OPO_CD", "CAN_OPO_REGION")
wl1 = merge(wl1, temp, by.x = "CAN_LISTING_OPO_ID", by.y = "CTR_ID", all.x = T)

# DEFINE MELDS TO REMOVE MORE AGAIN, LOOKING MORE CAREFULLY
# Ignore recods with MELD/PELD < 6, and set MELD as 41 for Status 1A, 1B:
rem_MELD = c("MELD/PELD -1", "MELD/PELD -2", "MELD/PELD -3", "MELD/PELD -4", "MELD/PELD -5", "MELD/PELD -6", "MELD/PELD -7", "MELD/PELD -8", "MELD/PELD -9", "MELD/PELD -10", "MELD/PELD -11", "MELD/PELD -12", "MELD/PELD 0", "MELD/PELD 1", "MELD/PELD 2", "MELD/PELD 3", "MELD/PELD 4", "MELD/PELD 5", "Status 2A", "Status 2B", "Status 3", "Temporarily Inactive", "Old status 2", "Old status 4", "Non-urgent")

# Demand trend (Since 1995):
wl$yr_mon = substr(as.character(wl$list_date), 1, 7)
wl$yr = substr(as.character(wl$yr_mon), 1, 4)
temp = data.table(wl)[, list(new_pat_cnt = .N), by = yr]
plot(temp[temp$yr != "2019", ]$yr, temp[temp$yr != "2019", ]$new_pat_cnt, xlab = "yr", ylab = "new_pat_cnt")

# Demand trend (Since 2010):
wl1$yr_mon = substr(as.character(wl1$list_date), 1, 7)
wl1$yr = substr(as.character(wl1$yr_mon), 1, 4)
temp = data.table(wl1)[, list(new_pat_cnt = .N), by = yr]
plot(temp[temp$yr != "2019", ]$yr, temp[temp$yr != "2019", ]$new_pat_cnt, xlab = "yr", ylab = "new_pat_cnt")

# Demand trend (Since 2010, Specified Regions only):
if (region == "all") {
  temp = data.table(wl1)[, list(new_pat_cnt = .N), by = yr]
} else if (region == 2) {
  temp = data.table(subset(wl1, CAN_OPO_REGION == 2))[, list(new_pat_cnt = .N), by = yr]
}
plot(temp[temp$yr != "2019", ]$yr, temp[temp$yr != "2019", ]$new_pat_cnt, xlab = "yr", ylab = "new_pat_cnt")
ggplot(temp[temp$yr != "2019", ], aes(x=yr, y=new_pat_cnt)) + 
    geom_point() + ylab("wedaw") + theme(text = element_text(size=20))

# Supply trend (Since 2010, Specified Regions only):
don$date <- as.Date(don$date, format= "%Y-%m-%d")
don$yr = substr(don$date, 1, 4)
if (region == "all") {
  temp1 = data.table(subset(don, DON_OPO_REGION != 98))[, list(new_don_cnt = .N), by = yr]
} else if (region == 2) {
  temp1 = data.table(subset(don, DON_OPO_REGION == 2))[, list(new_don_cnt = .N), by = yr]
}
temp1 = merge(temp1, temp, all.x = T)

# Combined graph of supply and demand:
temp1 <- melt(temp1[temp1$yr != "2019", ], id.vars="yr")
ggplot(temp1, aes(x=yr, y=value, col=variable, group=variable)) + 
  geom_point() + geom_line() + theme(text = element_text(size=20), panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  labs(x = "Year", y = "Count", color='') + scale_color_hue(labels = c("Deceased donors", "New patients")) + theme(axis.text.x=element_text(angle=90, hjust=1))    # family="Times"

temp = read_excel(paste0(fol_, "/Analysis/ptr_li_sample.xlsx"), sheet = "PTR_STAT_CD")
temp = as.data.frame(temp)
temp[, 1] = as.character(temp[, 1])
names(temp)[2] = "CAN_INIT_STAT_desp"
wl1 = merge(wl1, temp, by.x = "CAN_INIT_STAT", by.y = "Candidate's current Medical Urgency", all.x = T)
wl1 = wl1[!(wl1$CAN_INIT_STAT_desp %in% rem_MELD), ]  # ~5% records removed!

# Function to set MELD as 41 for Status 1A/1B patients and of those with MELD > 40!
MELD_mod = function(x) {
  temp = strsplit(as.character(x), split = " ")[[1]][2]
  if ((temp == "1A") | (temp == "1B") | (temp == "1")) {
    return (41)
  } else if (as.numeric(temp) > 40) {
    return (41)
  } else return (as.numeric(temp))
}
MELD_mod("Status 1A"); MELD_mod("MELD/PELD 21")

unique(wl1$CAN_INIT_STAT_desp)   # Should not contain any of the "rem_MELD"

wl1$MELD = sapply(wl1$CAN_INIT_STAT_desp, function(x) {MELD_mod(x)})
table(wl1$MELD)

temp = data.table(wl1)[, list(list_mean_MELD = mean(MELD)), by = list(CAN_OPO_CD, CAN_OPO_REGION, policy)]
if (region == 2) {
  temp = subset(temp, CAN_OPO_REGION == 2)
}

# write.xlsx(temp, paste0(fol_, "/Paper_writing/cand_INIT_MELD_sum.xlsx"), sheetName="Sheet1")
```

# Comparing the MELD of accepted offers:
```{r}
temp1 = df2[!(df2$PTR_STAT_CD_desp %in% rem_MELD), ]
temp1$MELD = sapply(temp1$PTR_STAT_CD_desp, function(x) {MELD_mod(x)})
summary(temp1$MELD)

# Box-plots of MELD at transplant, across policies:
##### REGION-wise, not feasible to plot all 52 DSAs in one plot!

temp1$DSA = temp1$CAN_OPO_CD; 
temp1$Policy = "Pre-Share 35"; temp1[temp1$policy == "post", "Policy"] = "Post-Share 35"
temp1$Policy = factor(temp1$Policy, levels = c("Pre-Share 35", "Post-Share 35"))

# Region 11:
cond1 = (temp1$PTR_OFFER_ACPT == "Y") & (temp1$CAN_OPO_REGION == 11)
ggplot(temp1[cond1, ], aes(x=Policy, y=MELD, fill = DSA)) + 
    geom_boxplot() + ylab("MELD at transplant") + theme(text = element_text(size=20))

cond1 = (temp1$CAN_OPO_REGION == 11)
ggplot(temp1[cond1, ], aes(x=Policy, y=MELD, fill = DSA)) + 
    geom_boxplot() + ylab("MELD at offer") + theme(text = element_text(size=20))

# All Regions:
cond1 = (temp1$PTR_OFFER_ACPT == "Y")
ggplot(temp1[cond1, ], aes(x=Policy, y=MELD)) + 
    geom_boxplot() + ylab("MELD at transplant") + theme(text = element_text(size=20))
ggplot(temp1[cond1, ], aes(x=Policy, y=MELD)) + 
    geom_boxplot() + ylab("MELD at transplant") + theme_bw(base_size = 20)

ggplot(temp1[, ], aes(x=Policy, y=MELD)) + 
    geom_boxplot() + ylab("MELD at offer") + theme(text = element_text(size=20))
ggplot(temp1[, ], aes(x=Policy, y=MELD)) + 
    geom_boxplot() + ylab("MELD at offer") + theme_bw(base_size = 20)

# theme(text = element_text(size=20), panel.background = element_blank(), axis.line = element_line(colour = "black"))

# cond = (temp1$MELD >= 35)
# temp = data.table(temp1[cond & (temp1$MELD < 35), ])[, list(avg_MELD = mean(MELD)), by = list(policy, CAN_OPO_CD, CAN_OPO_REGION)]
# ggplot(temp, mapping = aes(x = CAN_OPO_CD, y = avg_MELD)) + geom_point(aes(colour=factor(policy), group=factor(policy))) + facet_grid(~ CAN_OPO_REGION)
# write.csv(temp, "/Volumes/GoogleDrive/My Drive/SRTR/Analysis/temp.csv")
```

# Digging deeper into "MELD @ offer" and "MELD @ transplant":
```{r}
temp = subset(temp1, DONOR_ID == "344311")
write.csv(temp, "C:/Users/sakshat/Desktop/temp.csv", row.names = F)

# Histogram of MELD @ tx:
temp = data.table(temp1[temp1$PTR_OFFER_ACPT == "Y", ])[, list(tx_cnt = .N), by = list(new_PTR_STAT_CD_desp, Policy)]
temp = data.table(temp)[, tx_frac := tx_cnt / sum(tx_cnt), by = list(Policy)]

temp$MELD_class = str_remove(temp$new_PTR_STAT_CD_desp, "/PELD")
temp$MELD_class = factor(temp$MELD_class, levels = c("MELD 6-14", "MELD 15-28", "MELD 29-32", "MELD 33-34", "MELD 35-36", "MELD >36"))

ggplot(temp, aes(x=MELD_class, y=tx_frac, fill = Policy)) +
  geom_bar(stat="identity", position=position_dodge()) + labs(y = "Transplant fraction", x = "") + 
  theme(text = element_text(size=15), axis.text.x = element_text(angle = 45, hjust=1), panel.background = element_blank(), axis.line = element_line(colour = "black"))

f = function(PTR_OFFER_ACPT, MELD, val) {
  temp = data.frame(v1 = PTR_OFFER_ACPT, v2 = MELD)
  if (val == 1) {
    if (sum(PTR_OFFER_ACPT == "Y") >= 1) {
      return (mean(subset(temp, v1 == "Y")$v2))
    } else {
      return (NaN)
    }
  } else if (val == 0) {
    return (mean(subset(temp, v1 == "N")$v2))
  }
}

# Policy-wise:
temp11 = subset(temp1, policy == "post")

temp = data.table(temp11)[, list(cnt = .N, cnt_Y = sum(PTR_OFFER_ACPT == "Y"), MELD_acpt = f(PTR_OFFER_ACPT, MELD, 1),
                                 MELD_dec = f(PTR_OFFER_ACPT, MELD, 0), MELD_ofr = mean(MELD)), by = list(DONOR_ID)]

temp2 = temp[(temp$cnt == 1) & (temp$cnt_Y == 1), ]
temp2 = temp[(temp$cnt > 1), ]
summary(temp2$MELD_acpt); summary(temp2$MELD_dec)

# Category 1 + 2:
summary(temp$MELD_acpt); summary(temp$MELD_dec); summary(temp$MELD_ofr)

# Overall:
summary(temp1[temp1$PTR_OFFER_ACPT == "N", ]$MELD)

# Box plot:
temp = data.table(temp1)[, list(cnt = .N, cnt_Y = sum(PTR_OFFER_ACPT == "Y"), MELD_acpt = f(PTR_OFFER_ACPT, MELD, 1), MELD_ofr = mean(MELD)), by = list(DONOR_ID, Policy)]
ggplot(temp[, ], aes(x=Policy, y=MELD_ofr)) + 
    geom_boxplot() + ylab("MELD at offer") + theme(text = element_text(size=20))
ggplot(temp[, ], aes(x=Policy, y=MELD_acpt)) + 
    geom_boxplot() + ylab("MELD at transplant") + theme(text = element_text(size=20))

ggplot(temp[, ], aes(x=Policy, y=MELD_ofr)) + 
    geom_boxplot() + ylab("MELD at offer") + theme_bw(base_size = 20)
ggplot(temp[, ], aes(x=Policy, y=MELD_acpt)) + 
    geom_boxplot() + ylab("MELD at transplant") + theme_bw(base_size = 20)

# Remove these files:
rm(temp11); rm(temp12); rm(f)
```

# MELD vs PTR_SEQUENCE_NUM_upd and vice-versa:
```{r}
temp = data.table(temp1)[, list(First_quartile = quantile(PTR_SEQUENCE_NUM_upd, 0.25),
                                Median = quantile(PTR_SEQUENCE_NUM_upd, 0.50),
                                Third_quartile = quantile(PTR_SEQUENCE_NUM_upd, 0.75),
                                Mean = mean(PTR_SEQUENCE_NUM_upd)), by = list(MELD, policy)]
temp$Policy = "Pre-Share 35"; temp[temp$policy == "post", "Policy"] = "Post-Share 35"
ggplot(temp[temp$MELD > 14, ], aes(x=MELD, y=Mean, color=Policy, shape = Policy)) + 
    geom_point() + theme(text = element_text(size=20)) + labs(y = "Mean offer position") # + geom_line() 

summary(temp1$PTR_SEQUENCE_NUM_upd)

# MELD CATEGORY vs PTR_SEQUENCE_NUM_upd:
table(temp1$new_PTR_STAT_CD_desp)
temp = data.table(temp1)[, list(Mean_offer_position = mean(PTR_SEQUENCE_NUM_upd)), by = list(new_PTR_STAT_CD_desp, Policy)]
# temp = as.data.frame(dcast(temp, new_PTR_STAT_CD_desp ~ Policy, value.var = "Mean_offer_position"))

temp$MELD_class = str_remove(temp$new_PTR_STAT_CD_desp, "/PELD")
temp$MELD_class = factor(temp$MELD_class, levels = c("MELD 6-14", "MELD 15-28", "MELD 29-32", "MELD 33-34", "MELD 35-36", "MELD >36"))

ggplot(temp, aes(x=MELD_class, y=Mean_offer_position, fill = Policy)) +
  geom_bar(stat="identity", position=position_dodge()) + labs(y = "Mean offer position", x = "") + 
  theme(text = element_text(size=15), axis.text.x = element_text(angle = 45, hjust=1), panel.background = element_blank(), axis.line = element_line(colour = "black"))
#

# MELD scores are Ordinal numbers...summary statistics not appropriate. https://www.mathsisfun.com/numbers/cardinal-ordinal-nominal.html
temp = data.table(temp1)[, list(First_quartile = quantile(MELD, 0.25),
                                Median = quantile(MELD, 0.50),
                                Third_quartile = quantile(MELD, 0.75),
                                Mean = mean(MELD)), by = list(PTR_SEQUENCE_NUM_upd, policy)]

ggplot(temp[temp$PTR_SEQUENCE_NUM_upd <= 100, ], aes(x=PTR_SEQUENCE_NUM_upd, y=Mean, color=policy)) + 
    geom_line() + theme(text = element_text(size=20))
```

# Conditional on MELD<35 (>=35), the avg. MELD at acceptance:
```{r}
cond1 = (temp1$PTR_OFFER_ACPT == "Y")
cond_MELD = (temp1$MELD >= 35)

temp = data.table(temp1[cond1 & !cond_MELD, ])[, list(avg_MELD_acpt = mean(MELD)), by = list(policy)]
# Difference (MELD<35): 
temp[temp$policy == "post", "avg_MELD_acpt"] - temp[temp$policy == "pre", "avg_MELD_acpt"]

temp = data.table(temp1[cond1 & cond_MELD, ])[, list(avg_MELD_acpt = mean(MELD)), by = list(policy)]
# Difference (MELD>=35): 
temp[temp$policy == "post", "avg_MELD_acpt"] - temp[temp$policy == "pre", "avg_MELD_acpt"]
```

# Summary statistics of the Patients' and Donors' characterisitcs:
```{r}
# Patients:
if (region == "all") {
  wl2 = wl1
} else if (region == 2) {
  wl2 = subset(wl1, CAN_OPO_REGION == 2)
}

min(wl2$list_date); max(wl2$list_date)
pat = subset(wl2, (wl2$list_date >= "2010-01-01") & (wl2$list_date < "2019-01-01") & (CAN_AGE_IN_MONTHS_AT_LISTING >= 18*12))

temp = data.table(pat)[, list(avg_age = mean(CAN_AGE_IN_MONTHS_AT_LISTING)/12, sd_age = sd(CAN_AGE_IN_MONTHS_AT_LISTING)/12, 
                              avg_MELD_listing = mean(MELD), sd_MELD_listing = sd(MELD)), by = list(policy)]
wl2$CAN_LIFE_SUPPORT = as.character(wl2$CAN_LIFE_SUPPORT)
wl2$CAN_LIFE_SUPPORT = gsub("b'", "", wl2$CAN_LIFE_SUPPORT)
wl2$CAN_LIFE_SUPPORT = gsub("'", "", wl2$CAN_LIFE_SUPPORT)

wl2$rec_life_sup = "No"
wl2[(!is.na(wl2$CAN_LIFE_SUPPORT) & (wl2$CAN_LIFE_SUPPORT == "Y")), "rec_life_sup"] = "Yes"
wl2$rec_med_cond = "NH"    # Missing is treated as 'not-hospitalized' in graft survival model of SRTR (See HZ coefficients)
wl2[(!is.na(wl2$CAN_MED_COND)) & (wl2$CAN_MED_COND == 2), "rec_med_cond"] = "H"
wl2[(!is.na(wl2$CAN_MED_COND)) & (wl2$CAN_MED_COND == 1), "rec_med_cond"] = "ICU"

table(wl2$rec_life_sup, wl2$policy)
table(wl2$rec_med_cond, wl2$policy)

# Donors:
min(don$date); max(don$date)
if (region == "all") {
  don1 = subset(don, (don$date >= "2010-01-01") & (don$date < "2019-01-01") & (don$DON_AGE >=18))
} else if (region == 2) {
  don1 = subset(don, (don$date >= "2010-01-01") & (don$date < "2019-01-01") & (don$DON_OPO_REGION == 2) & (don$DON_AGE >=18))
}
temp = data.table(don1)[, list(avg_age = mean(DON_AGE_IN_MONTHS)/12, sd_age = sd(DON_AGE_IN_MONTHS)/12), by = list(policy)]

table(don1$DON_RACE_SRTR, don1$policy)
table(don1$DON_CAD_DON_COD_desp, don1$policy)
table(is.na(don1$DON_DCD_SUPPORT_WITHDRAW_TM), don1$policy)
table(don1$DON_DISCARD_CD_desp, don1$policy)

# Match:
## Offers per organ (Non-sensical for df2 which contains only Region2 patients...ofrs are made to other Region patients as well)
min(df2$date); max(df2$date)
temp = subset(df2, (PTR_OFFER_ACPT == "Y") & (policy == "pre")); mean(temp$PTR_SEQUENCE_NUM_upd); sd(temp$PTR_SEQUENCE_NUM_upd)
temp = subset(df2, (PTR_OFFER_ACPT == "Y") & (policy == "post")); mean(temp$PTR_SEQUENCE_NUM_upd); sd(temp$PTR_SEQUENCE_NUM_upd)

# Discards:

# CIT:
tx$date <- as.Date(tx$date, format= "%Y-%m-%d")
min(tx$date); max(tx$date)
if (region == "all") {
  tx1 = subset(tx, (tx$date < "2019-01-01"))
} else if (region == 2) {
  tx1 = subset(tx, (tx$date < "2019-01-01") & (tx$REC_OPO_REGION == 2))
}

tx1$policy = sapply(c(1:nrow(tx1)), function(i) {if (tx1$date[i] > "2013-06-17") {return ("post")} else {return ("pre")}}) 

sum(is.na(tx1$REC_COLD_ISCH_TM))
tx1 = subset(tx1, !is.na(REC_COLD_ISCH_TM))
temp = subset(tx1, (policy == "pre")); mean(temp$REC_COLD_ISCH_TM); sd(temp$REC_COLD_ISCH_TM)
temp = subset(tx1, (policy == "post")); mean(temp$REC_COLD_ISCH_TM); sd(temp$REC_COLD_ISCH_TM)
```

# Conclusion section:
```{r}
# Donors recovered in Region 2:
df = merge(df, don[, c("DONOR_ID", "DON_OPO_REGION")], by.x = "DONOR_ID", by.y = "DONOR_ID", all.x = T)
sum(is.na(df$DON_OPO_REGION))

if (region == "all") {
  temp = subset(df, (PTR_OFFER_ACPT == "Y"))
} else if (region == 2) {
  temp = subset(df, (df$DON_OPO_REGION == "2") & (PTR_OFFER_ACPT == "Y"))
}

table(temp$sharing, temp$policy)
names(df2)
```

# Calculating "Donor Risk Index (DRI)":
```{r}
N_after_Y_filter = 1
don = read.csv(paste0(fol_, "/Analysis/Transition_matrix/donor_type_48", ifelse(N_after_Y_filter == 1, "_NoN_after_Y.csv", ".csv")))
# names(don)
```

```{r}
# Terms inside the EXPONENTIAL:
don$par_DRI = sapply(c(1:nrow(don)), function(i) {ifelse((don$DON_AGE[i] >= 40) & (don$DON_AGE[i] < 50), 0.154, 0) + ifelse((don$DON_AGE[i] >= 50) & (don$DON_AGE[i] < 60), 0.274, 0) + ifelse((don$DON_AGE[i] >= 60) & (don$DON_AGE[i] < 70), 0.424, 0) + ifelse((don$DON_AGE[i] >= 70), 0.501, 0) +
  ifelse((don$cod_type[i] == "Anoxia"), 0.079, 0) + ifelse((don$cod_type[i] == "CVA"), 0.145, 0) + ifelse((don$cod_type[i] == "Other"), 0.184, 0) + 
  ifelse((don$DON_RACE_SRTR[i] == "BLACK"), 0.176, 0) + ifelse((don$DON_RACE_SRTR[i] != "BLACK"), 0.126, 0) +
  ifelse((don$dcd_type[i] == "Yes"), 0.411, 0) +   # No column for identifying PARTIAL/SPLIT liver
  0.066 * (170 - don$DON_HGT_CM[i])/10 + 0.010 * (0-8)})   # Assume 'local sharing' since no term for 'sharing_type' and 'CIT=0'!

match1_src = df[!is.na(df$CAN_OPO_REGION), ]
match1_src = merge(match1_src, don[, c("DONOR_ID", "par_DRI")], by = "DONOR_ID", all.x = T)

match1_src$par_DRI2 = sapply(c(1:nrow(match1_src)), function(i) {match1_src$par_DRI[i] +     # Adding 'sharing_type' and 'CIT=6.9'
    ifelse(match1_src$sharing[i] == "regional", 0.105, 0) + ifelse(match1_src$sharing[i] == "national", 0.244, 0) + 
    0.010 * (6.9-8) - (0.010 * (0-8))})     # CIT = 6.9 

ASSUMES THAT EVEN ACCPETED OFFERS HAS 6.9 AS THE CIT!!!

# summary(match1_src$par_DRI2)

# Exponentiating the "par_DRI2":
match1_src$DRI_fix_cit = exp(match1_src$par_DRI2)
summary(match1_src$DRI_fix_cit); uniqueN(match1_src$DRI)
cor(match1_src$DRI_fix_cit, match1_src$GSi)    # Negative as expected: Higher DRI means lower survival.

# Summarizing:
table(match1_src$PTR_OFFER_ACPT)/nrow(match1_src)     # 5.6% acceptance, i.e., 1/20

temp = data.table(match1_src)[, list(mean_DRI = mean(DRI_fix_cit)), by = list(policy, PTR_OFFER_ACPT)]
temp = data.table(match1_src)[, list(mean_DRI = mean(DRI_fix_cit)), by = list(policy, PTR_OFFER_ACPT, CAN_OPO_REGION)]

match1_src$Policy = as.character(match1_src$policy)
match1_src[match1_src$policy == "pre", "Policy"] = "Pre-Share 35"; match1_src[match1_src$policy == "post", "Policy"] = "Post-Share 35"
  
match1_src$Policy = factor(match1_src$Policy, levels = c("Pre-Share 35", "Post-Share 35"))

# Plotting DRI of DECLINED offers:
ggplot(match1_src[match1_src$PTR_OFFER_ACPT == "N", ], aes(x=Policy, y=DRI_fix_cit)) +
  geom_boxplot() + ylab("DRI") + theme(text = element_text(size=20))

ggplot(match1_src[match1_src$PTR_OFFER_ACPT == "N", ], aes(x=Policy, y=DRI_fix_cit)) +
  geom_boxplot() + ylab("DRI") + theme_bw(base_size = 20)

write.csv(temp, "/Users/sakshat/Desktop/temp.csv", row.names = F)

# Associated DRI for each 'organ_type (as per the State space elements)':(
temp = data.table(don[!is.na(don$par_DRI), ])[, list(mean_par_DRI = mean(par_DRI), mean_DRI_adj = mean(exp(par_DRI))), by = list(type)]    # sum(is.na(don$par_DRI))

write.csv(temp, "/Users/sakshat/Desktop/temp.csv", row.names = F)

m = lm(par_DRI ~ age_type + race_type + cod_type + dcd_type, data = don)
summary(m)
```

# Change in 'DRI_fix_cit' of DECLINED offers:
```{r}
cond = (match1_src$PTR_OFFER_ACPT == "N")
temp = data.table(match1_src[cond & (match1_src$policy == "pre"), ])[, list(mean_DRI = mean(DRI_fix_cit)), by = list(new_PTR_STAT_CD_desp, CAN_OPO_REGION, policy)]

temp1 = as.data.frame(dcast(temp, CAN_OPO_REGION ~ new_PTR_STAT_CD_desp, value.var = "mean_DRI"))

write.csv(temp1, "/Users/shubham/Desktop/temp_pre.csv", row.names = F)

temp = data.table(match1_src[cond, ])[, list(mean_DRI = mean(DRI_fix_cit)), by = list(new_PTR_STAT_CD_desp, policy)]
temp1 = as.data.frame(dcast(temp, new_PTR_STAT_CD_desp ~ policy, value.var = "mean_DRI")); temp1$diff = temp1$post - temp1$pre
```

# Change in 'GSi' of ACCEPTED offers:
```{r}
Need to incorporate ACTUAL CIT!!!
cond_Y = (match1_src$PTR_OFFER_ACPT == "Y")
temp = data.table(match1_src[cond_Y & (match1_src$policy == "pre"), ])[, list(mean_GS = mean(GSi)), by = list(new_PTR_STAT_CD_desp, CAN_OPO_REGION, policy)]
temp1 = as.data.frame(dcast(temp, CAN_OPO_REGION ~ new_PTR_STAT_CD_desp, value.var = "mean_GS"))

temp = data.table(match1_src[cond_Y, ])[, list(mean_GS = mean(GSi)), by = list(new_PTR_STAT_CD_desp, policy)]
temp1 = as.data.frame(dcast(temp, new_PTR_STAT_CD_desp ~ policy, value.var = "mean_GS")); temp1$diff = temp1$post - temp1$pre

```


```{r}
# Distribution of DRI across Regions:
temp = data.table(don[!is.na(don$par_DRI), ])[, list(mean_par_DRI = mean(par_DRI), mean_DRI_adj = mean(exp(par_DRI))), by = list(DON_OPO_REGION)]    

summary(exp(don$par_DRI))

ggplot(don[!is.na(don$par_DRI), ], aes(x=as.factor(DON_OPO_REGION), y=exp(par_DRI), color=as.factor(DON_OPO_REGION))) +
  geom_boxplot()

don$date = as.Date(don$date, format= "%Y-%m-%d")

don1 = subset(don,  (date >= "2013-07-01") & (date < "2017-07-01") & (DON_OPO_REGION != 98) & (!is.na(par_DRI)))
don1$par_DRI = don1$par_DRI - 0.08
ggplot(don1[, ], aes(x=as.factor(DON_OPO_REGION), y=exp(par_DRI))) +
  geom_boxplot(outlier.shape = NA) + labs(x = "OPTN Region", y = "DRI") +# + ylim(0.5, 3) +
theme(text = element_text(size=18))

```

#### Case of Region 9 and Region 6:
```{r}
match1 = subset(df2, CAN_OPO_REGION == 9)

table(match1$CAN_OPO_CD)

temp = data.table(df2)[, list(offers = .N, p_acpt = sum(PTR_OFFER_ACPT == "Y")/.N), by = list( policy, CAN_OPO_REGION)]

# Supply and demand- Region wise:
temp = data.table(don)[, list(sup = .N), by = list(policy, DON_OPO_REGION)]

temp = data.table(wl1)[, list(dem = .N), by = list(policy, CAN_OPO_REGION)]

write.csv(temp, "/Users/sakshat/Desktop/temp.csv", row.names = F)

```

```{r}
names(wl1)
sum(is.na(wl1$DONOR_ID))

```

```{r}
lst = c("CAN_BACTERIA_PERIT", "CAN_ABO", "CAN_GENDER", "CAN_LIFE_SUPPORT", "CAN_PORTAL_VEIN", "CAN_PREV_ABDOM_SURG", "CAN_MALIG", "CAN_RACE_SRTR", "CAN_ETHNICITY_SRTR", "CAN_TIPSS", "CAN_WORK_INCOME")
for (col in lst) {
  wl1[, col] = as.character(wl1[, col])
  wl1[, col] = gsub("b'", "", wl1[, col])
  wl1[, col] = gsub("'", "", wl1[, col])
}

# Need to remove outliers:
wl1[!is.na(wl1$CAN_LAST_SERUM_CREAT) & (wl1$CAN_LAST_SERUM_CREAT > 7.3) , "CAN_LAST_SERUM_CREAT"] = 7.3
wl1[!is.na(wl1$CAN_BMI) & (wl1$CAN_BMI > 45) , "CAN_BMI"] = 45

# Get 'numerical' values of MELD:
temp = read_excel(paste0(fol_, "/Analysis/ptr_li_sample.xlsx"), sheet = "PTR_STAT_CD")
temp = as.data.frame(temp)
temp[, 1] = as.character(temp[, 1])
names(temp)[2] = "CAN_INIT_SRTR_LAB_MELD_desp"
wl1 = merge(wl1, temp, by.x = "CAN_INIT_SRTR_LAB_MELD", by.y = "Candidate's current Medical Urgency", all.x = T)

# unique(wl1$CAN_INIT_STAT_desp)   # Should not contain any of the "rem_MELD"

wl1$LAB_MELD = sapply(wl1$CAN_INIT_STAT_desp, function(x) {ifelse(is.na(x), 22, MELD_mod(x))})    # Median value
table(wl1$LAB_MELD)
```

# Calculating 'Survival proability after listing':
```{r}
rm(wl)

WL_hr_coeff_src = read_excel(paste0(fol_, "/Analysis/survival_coefficients.xlsx"), sheet = "WL_1")

# Will have to calculate harard ratio of different intervals separately and then sum them up weighing by the length of the intervals. Have think of where to incorporate the Time-overall effect (-9.229455)? 

haz_ratio_WL_S1 = function(wl1, i, WL_hr_coeff_src, interval) {    # interval can be: "Overall", "0-<3 months", "3-<6 months", "6-<12 months"
  
  # hr_coeff_vec_OVERALL = WL_hr_coeff_src[WL_hr_coeff_src$`Follow-up Period` == "Overall", ]$Coefficient
  # hr_coeff_vec = WL_hr_coeff_src[WL_hr_coeff_src$`Follow-up Period` == interval, ]$Coefficient
  
  df_OVERALL = WL_hr_coeff_src[WL_hr_coeff_src$`Follow-up Period` == "Overall", ]
  df_INTERVAL = WL_hr_coeff_src[WL_hr_coeff_src$`Follow-up Period` == interval, ]
  
  val = 0
  
  x = wl1$CAN_AGE_AT_LISTING[i]     # Recipient age
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate age"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate age"), ]

  if (interval == "0-<3 months") {

    if(x < 60) {val = val + temp1[temp1$Level == "Apply to < 60 (Left LS)", ]$Coefficient[1] * (60-x)}
    if(x > 50) {val = val + temp1[temp1$Level == "Apply to > 50 (Right LS)", ]$Coefficient[1] * (x-50)}
    if(x > 55) {val = val + temp1[temp1$Level == "Apply to > 55 (Right LS)", ]$Coefficient[1] * (x-55)}
    if(x > 65) {val = val + temp1[temp1$Level == "Apply to > 65 (Right LS)", ]$Coefficient[1] * (x-65)}
    if(x > 80) {val = val + temp1[temp1$Level == "Apply to > 80 (Right LS)", ]$Coefficient[1] * (x-80)}
  } else if (interval == "3-<6 months") {
    if(x > 50) {val = val + temp1[temp1$Level == "Apply to > 50 (Right LS)", ]$Coefficient[1] * (x-50)}
    if(x > 60) {val = val + temp1[temp1$Level == "Apply to > 60 (Right LS)", ]$Coefficient[1] * (x-60)}
    if(x > 75) {val = val + temp1[temp1$Level == "Apply to > 75 (Right LS)", ]$Coefficient[1] * (x-75)}
  } else if (interval == "6-<12 months") {
    if(x < 40) {val = val + temp1[temp1$Level == "Apply to < 40 (Left LS)", ]$Coefficient[1] * (40-x)}
    if(x > 50) {val = val + temp1[temp1$Level == "Apply to > 50 (Right LS)", ]$Coefficient[1] * (x-50)}
    if(x > 70) {val = val + temp1[temp1$Level == "Apply to > 70 (Right LS)", ]$Coefficient[1] * (x-70)}
  }
  if (x > 30) {val = val + temp2[temp2$Level == "Apply to > 30 (Right LS)", ]$Coefficient[1] * (x-30)}
  if (x > 50) {val = val + temp2[temp2$Level == "Apply to > 50 (Right LS)", ]$Coefficient[1] * (x-50)}
  if (x > 55) {val = val + temp2[temp2$Level == "Apply to > 55 (Right LS)", ]$Coefficient[1] * (x-55)}
  if (x > 60) {val = val + temp2[temp2$Level == "Apply to > 60 (Right LS)", ]$Coefficient[1] * (x-60)}
  if (x > 80) {val = val + temp2[temp2$Level == "Apply to > 80 (Right LS)", ]$Coefficient[1] * (x-80)}

  x = wl1$CAN_ASCITES[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate ascites"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate ascites"), ]
  if (interval == "0-<3 months") {
    if (x == "") {val = val + temp1[temp1$Level == "Absent", ]$Coefficient[1]}
  } else if (interval == "3-<6 months") {
    if (x == "") {val = val + temp1[temp1$Level == "Absent", ]$Coefficient[1]}
  }
  if (x == "") {val = val + temp2[temp2$Level == "Absent", ]$Coefficient[1]}
  
  x = wl1$CAN_BACTERIA_PERIT[i]   # unique(wl1$CAN_BACTERIA_PERIT)
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had bacterial peritonitis"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate had bacterial peritonitis"), ]
  if (interval == "0-<3 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  } else if (interval == "6-<12 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  if (x == "Y") {val = val + temp2[temp2$Level == "Yes", ]$Coefficient[1]}
   
  x = wl1$CAN_ABO[i]   # unique(wl1$CAN_ABO)
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate blood type"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate blood type"), ]
  if (interval == "6-<12 months") {
    if (x %in% c("A", "A1", "A2")) {val = val + temp1[temp1$Level == "A", ]$Coefficient[1]}
    if (x %in% c("AB", "A1B")) {val = val + temp1[temp1$Level == "AB", ]$Coefficient[1]}
  }
  if (x %in% c("AB", "A1B")) {val = val + temp2[temp2$Level == "AB", ]$Coefficient[1]}
  if (x %in% c("B")) {val = val + temp2[temp2$Level == "B", ]$Coefficient[1]}
  
  x = wl1$CAN_BMI[i]   # unique(wl1$CAN_BMI)
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate BMI"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate BMI"), ]
  if (is.na(x)) {x = 27}   # The most-frequent outcome!
  if (interval == "0-<3 months") {
    if (x < 22) {val = val + temp1[temp1$Level == "Apply to < 22 (Left LS)", ]$Coefficient[1] * (22-x)}
    if (x < 20) {val = val + temp1[temp1$Level == "Apply to < 20 (Left LS)", ]$Coefficient[1] * (20-x)}
    if (x < 28) {val = val + temp1[temp1$Level == "Apply to < 28 (Left LS)", ]$Coefficient[1] * (28-x)}
  } else if (interval == "3-<6 months") {
    if (x < 24) {val = val + temp1[temp1$Level == "Apply to < 24 (Left LS)", ]$Coefficient[1] * (24-x)}
  } else if (interval == "6-<12 months") {
    if (x < 20) {val = val + temp1[temp1$Level == "Apply to < 20 (Left LS)", ]$Coefficient[1] * (20-x)}
  }
  if (x < 28) {val = val + temp2[temp2$Level == "Apply to < 28 (Left LS)", ]$Coefficient[1] * (28-x)}
  if (x < 30) {val = val + temp2[temp2$Level == "Apply to < 30 (Left LS)", ]$Coefficient[1] * (30-x)}
  if (x > 34) {val = val + temp2[temp2$Level == "Apply to > 34 (Right LS)", ]$Coefficient[1] * (x-34)}
  if (x > 42) {val = val + temp2[temp2$Level == "Apply to > 42 (Right LS)", ]$Coefficient[1] * (x-42)}
  
  x = wl1$CAN_CITIZENSHIP[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate citizen status"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate citizen status"), ]
  if (is.na(x)) {x = 1}   # The most-frequent outcome!
  if (interval == "6-<12 months") {
    if (x %in% c(2, 4, 5, 6)) {val = val + temp1[temp1$Level == "Resident, non-citizen", ]$Coefficient[1]}
  }
  if (x %in% c(3, 4, 5, 6)) {val = val + temp2[temp2$Level == "Non-resident, non-citizen", ]$Coefficient[1]}
  
  x = wl1$CAN_DGN[i]    # Primary diagnosis
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Primary diagnosis"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Primary diagnosis"), ]
  if (is.na(x)) {x = 4204}   # The most-frequent outcome!
  if (interval == "0-<3 months") {
    if(x %in% c(4220, 4230, 4231, 4235, 4240, 4241, 4242, 4245, 4250, 4255, 4260, 4264)) {val = val + temp1[temp1$Level == "Cholestatic cirrhosis", ]$Coefficient[1]}
    if(x %in% c(4265, 4280, 4285, 4290, 4450, 4451, 4455, 4500, 4510, 4520, 4597)) {val = val + temp1[temp1$Level == "Other", ]$Coefficient[1]}
  } else if (interval == "3-<6 months") {
    if(x %in% c(4220, 4230, 4231, 4235, 4240, 4241, 4242, 4245, 4250, 4255, 4260, 4264)) {val = val + temp1[temp1$Level == "Cholestatic cirrhosis", ]$Coefficient[1]}
    if(x %in% c(4265, 4280, 4285, 4290, 4450, 4451, 4455, 4500, 4510, 4520, 4597)) {val = val + temp1[temp1$Level == "Other", ]$Coefficient[1]}
  } else if (interval == "6-<12 months") {
    if (x %in% c(4270, 4271, 4272, 4275)) {val = val + temp1[temp1$Level == "Biliary atresia", ]$Coefficient[1]}
    if (x %in% c(4400, 4401, 4402, 4403, 4404, 4405, 4410, 4420, 4430)) {val = val + temp1[temp1$Level == "Malignant neoplasm", ]$Coefficient[1]}
    if (x %in% c(4300, 4301, 4302, 4303, 4304, 4305, 4306, 4307, 4308, 4315)) {val = val + temp1[temp1$Level == "Metabolic", ]$Coefficient[1]}
  }
  if (x %in% c(4100, 4101, 4102, 4103, 4104, 4105, 4106, 4107, 4108, 4110, 4217, 4592, 4593)) {val = val + temp2[temp2$Level == "Acute hepatic necrosis", ]$Coefficient[1]}
  if (x %in% c(4400, 4401, 4402, 4403, 4404, 4405, 4410, 4420, 4430)) {val = val + temp2[temp2$Level == "Malignant neoplasm", ]$Coefficient[1]}
  if (x %in% c(4300, 4301, 4302, 4303, 4304, 4305, 4306, 4307, 4308, 4315)) {val = val + temp2[temp2$Level == "Metabolic", ]$Coefficient[1]}
  if (x %in% c(4220, 4230, 4231, 4235, 4240, 4241, 4242, 4245, 4250, 4255, 4260, 4264)) {val = val + temp2[temp2$Level == "Cholestatic cirrhosis", ]$Coefficient[1]}
  
  x = wl1$CAN_DIAB_TY[i]     # Candidate diabetes status/type at onset
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate diabetes type"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate diabetes type"), ]
  if (is.na(x)) {x = 5}   # Type Unknown
  if (interval == "3-<6 months") {
    if (x %in% c(4, 5)) {val = val + temp1[temp1$Level == "Other", ]$Coefficient[1]}
  } else if (interval == "6-<12 months") {
    if (x == 3) {val = val + temp1[temp1$Level == "Type 2", ]$Coefficient[1]}
  }
  if (x %in% c(4, 5)) {val = val + temp2[temp2$Level == "Other", ]$Coefficient[1]}
  if (x == 3) {val = val + temp2[temp2$Level == "Type 2", ]$Coefficient[1]}
  if (x == 2) {val = val + temp2[temp2$Level == "Type 1", ]$Coefficient[1]}
  
  x = wl1$CAN_EDUCATION[i]    # unique(wl1$CAN_EDUCATION)
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate education"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate education"), ]
  if (is.na(x)) {x = 996}   # 
  if (interval == "0-<3 months") {
    if (x == 5) {val = val + temp1[temp1$Level == "Associate or bachelor degree", ]$Coefficient[1]}
    if (x < 2) {val = val + temp1[temp1$Level == "Less than high school", ]$Coefficient[1]}
    if (x %in% c(4)) {val = val + temp1[temp1$Level == "Some college", ]$Coefficient[1]}
  } else if (interval == "3-<6 months") {
    if (x < 2) {val = val + temp1[temp1$Level == "Less than high school", ]$Coefficient[1]}
  } else if (interval == "6-<12 months") {
    if (x == 5) {val = val + temp1[temp1$Level == "Associate or bachelor degree", ]$Coefficient[1]}
  }
  if (x == 6) {val = val + temp2[temp2$Level == "Graduate degree", ]$Coefficient[1]}
  if (x == 5) {val = val + temp2[temp2$Level == "Associate or bachelor degree", ]$Coefficient[1]}
  if (x %in% c(4)) {val = val + temp2[temp2$Level == "Some college", ]$Coefficient[1]}
  
  x = wl1$CAN_HGT_CM[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate height (cm)"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate height (cm)"), ]
  if (is.na(x)) {x = 170.2}   # Median
  if (interval == "0-<3 months") {
    if (x < 155) {val = val + temp1[temp1$Level == "Apply to < 155 (Left LS)", ]$Coefficient[1] * (155-x)}
    if (x < 175) {val = val + temp1[temp1$Level == "Apply to < 175 (Left LS)", ]$Coefficient[1] * (175-x)}
    if (x < 170) {val = val + temp1[temp1$Level == "Apply to < 170 (Left LS)", ]$Coefficient[1] * (170-x)}
  } else if (interval == "3-<6 months") {
    if (x < 165) {val = val + temp1[temp1$Level == "Apply to < 165 (Left LS)", ]$Coefficient[1] * (165-x)}
    if (x < 175) {val = val + temp1[temp1$Level == "Apply to < 175 (Left LS)", ]$Coefficient[1] * (175-x)}
    if (x < 170) {val = val + temp1[temp1$Level == "Apply to < 170 (Left LS)", ]$Coefficient[1] * (170-x)}
  } else if (interval == "6-<12 months") {
    if (x < 155) {val = val + temp1[temp1$Level == "Apply to < 155 (Left LS)", ]$Coefficient[1] * (155-x)}
    if (x < 160) {val = val + temp1[temp1$Level == "Apply to < 160 (Left LS)", ]$Coefficient[1] * (160-x)}
  }
  if (x < 165) {val = val + temp2[temp2$Level == "Apply to < 165 (Left LS)", ]$Coefficient[1] * (165-x)}
  if (x < 170) {val = val + temp2[temp2$Level == "Apply to < 170 (Left LS)", ]$Coefficient[1] * (170-x)}
    
  x = wl1$CAN_GENDER[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate sex"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate sex"), ]
  if (interval == "0-<3 months") {
    if (x == "F") {val = val + temp1[temp1$Level == "Female", ]$Coefficient[1]}
  }
  if (x == "F") {val = val + temp2[temp2$Level == "Female", ]$Coefficient[1]}
    
  x = wl1$CAN_LIFE_SUPPORT[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate on life support"), ]
  if (interval == "0-<3 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  
  x = wl1$CAN_PRIMARY_PAY[i]   # unique(wl1$CAN_PRIMARY_PAY)
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate insurance provider"), ]
  if (is.na(x)) {x = 1}    # Most frequent
  if (x %in% c(1, 8, 9, 10, 11, 12, 14, 15)) {val = val + temp2[temp2$Level == "Other", ]$Coefficient[1]}
  if (x %in% c(3, 4, 5, 6, 7, 13)) {val = val + temp2[temp2$Level == "Public: Not medicaid", ]$Coefficient[1]}
  if (x == 2) {val = val + temp2[temp2$Level == "Public: Medicaid", ]$Coefficient[1]}
  
  x = wl1$CAN_PORTAL_VEIN[i]      # Recipient portal vein thr_coeff_vecombosis
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had history of portal vein thrombosis"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate had history of portal vein thrombosis"), ]
  if (interval == "3-<6 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  } else if (interval == "6-<12 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  if (x == "Y") {val = val + temp2[temp2$Level == "Yes", ]$Coefficient[1]}
  
  x = wl1$CAN_PREV_ABDOM_SURG[i]     # Recipient previous abdominal surgery
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had prior abdominal surgery"), ]
  if (interval == "0-<3 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  } else if (interval == "3-<6 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  } else if (interval == "6-<12 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  
  x = wl1$CAN_MALIG[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had a previous malignancy"), ]
  if (interval == "3-<6 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  
  x = wl1$CAN_PREV_HR[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had a prior heart transplant"), ]
  if (interval == "0-<3 months") {
    if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  
  x = wl1$CAN_PREV_IN[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had a prior intestine transplant"), ]
  if (interval == "6-<12 months") {
    if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  } else if (interval == "3-<6 months") {
    if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  
  x = wl1$CAN_PREV_KI[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had a prior kidney transplant"), ]
  if (interval == "3-<6 months") {
    if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  
  x = wl1$CAN_PREV_KP[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had a prior kidney-pancreas transplant"), ]
  if (interval == "0-<3 months") {
    if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  
  x = wl1$CAN_PREV_LI[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had a prior liver transplant"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate had a prior liver transplant"), ]
  if (interval == "0-<3 months") {
    if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  } else if (interval == "3-<6 months") {
    if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  } else if (interval == "6-<12 months") {
    if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  if (x == 1) {val = val + temp2[temp2$Level == "Yes", ]$Coefficient[1]}
  
  x = wl1$CAN_PREV_PA[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had a prior pancreas transplant"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate had a prior pancreas transplant"), ]
  if (interval == "3-<6 months") {
    if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  if (x == 1) {val = val + temp2[temp2$Level == "Yes", ]$Coefficient[1]}
  
  x = wl1$CAN_RACE_SRTR[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate race: Asian"), ]
  if (interval == "6-<12 months") {
    if (x == "ASIAN") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate race: Black"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate race: Black"), ]
  if (interval == "3-<6 months") {
    if (x == "BLACK") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  if (x == "BLACK") {val = val + temp2[temp2$Level == "Yes", ]$Coefficient[1]}
  
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate race: Other"), ]
  if (interval == "0-<3 months") {
    if (!(x %in% c("ASIAN", "BLACK"))) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  } else if (interval == "3-<6 months") {
    if (!(x %in% c("ASIAN", "BLACK"))) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  
  x = wl1$CAN_ETHNICITY_SRTR[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate ethnicity: Latino"), ]
  if (interval == "3-<6 months") {
    if (x == "LATINO") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  
  x = wl1$CAN_TIPSS[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate had TIPSS"), ]
  if (interval == "6-<12 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  } else if (interval == "0-<3 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  
  x = wl1$CAN_WGT_KG[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate weight (kg)"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate weight (kg)"), ]
  if (is.na(x)) {x = 81.6}   # Median
  if (interval == "0-<3 months") {
    if (x < 70) {val = val + temp1[temp1$Level == "Apply to < 70 (Left LS)", ]$Coefficient[1] * (70-x)}
    if (x < 80) {val = val + temp1[temp1$Level == "Apply to < 80 (Left LS)", ]$Coefficient[1] * (80-x)}
    if (x > 140) {val = val + temp1[temp1$Level == "Apply to > 140 (Right LS)", ]$Coefficient[1] * (x-140)}
  } else if (interval == "6-<12 months") {
    if (x < 50) {val = val + temp1[temp1$Level == "Apply to < 50 (Left LS)", ]$Coefficient[1] * (50-x)}
    if (x > 110) {val = val + temp1[temp1$Level == "Apply to > 110 (Right LS)", ]$Coefficient[1] * (x-110)}
  }
  if (x > 140) {val = val + temp2[temp2$Level == "Apply to > 140 (Right LS)", ]$Coefficient[1] * (x-140)}
  
  x = wl1$CAN_WORK_INCOME[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate was working for income"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate was working for income"), ]
  if (interval == "6-<12 months") {
    if (x == "Y") {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  }
  if (x == "Y") {val = val + temp2[temp2$Level == "Yes", ]$Coefficient[1]}
  
  x = wl1$CAN_LAST_ALBUMIN[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate albumin"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate albumin"), ]
  if (is.na(x)) {x = 3.1}   # Median
  if (interval == "0-<3 months") {
    if (x < 2.5) {val = val + temp1[temp1$Level == "Apply to < 2.5 (Left LS)", ]$Coefficient[1] * (2.5-x)}
    if (x < 3) {val = val + temp1[temp1$Level == "Apply to < 3 (Left LS)", ]$Coefficient[1] * (3-x)}
  } else if (interval == "3-<6 months") {
    if (x < 4) {val = val + temp1[temp1$Level == "Apply to < 4 (Left LS)", ]$Coefficient[1] * (4-x)}
    if (x < 3.5) {val = val + temp1[temp1$Level == "Apply to < 3.5 (Left LS)", ]$Coefficient[1] * (3.5-x)}
  } else if (interval == "6-<12 months") {
    if (x < 2) {val = val + temp1[temp1$Level == "Apply to < 2 (Left LS)", ]$Coefficient[1] * (2-x)}
    if (x < 4) {val = val + temp1[temp1$Level == "Apply to < 4 (Left LS)", ]$Coefficient[1] * (4-x)}
  }
  if (x < 4) {val = val + temp2[temp2$Level == "Apply to < 4 (Left LS)", ]$Coefficient[1] * (4-x)} 
  if (x > 3.5) {val = val + temp2[temp2$Level == "Apply to > 3.5 (Right LS)", ]$Coefficient[1] * (x-3.5)}
  if (x > 4.5) {val = val + temp2[temp2$Level == "Apply to > 4.5 (Right LS)", ]$Coefficient[1] * (x-4.5)}
  
  x = wl1$CAN_LAST_SERUM_SODIUM[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate serum sodium"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate serum sodium"), ]
  if (is.na(x)) {x = 137}   # Median
  if (interval == "0-<3 months") {
    if (x < 124) {val = val + temp1[temp1$Level == "Apply to < 124 (Left LS)", ]$Coefficient[1] * (124-x)}
    if (x < 138) {val = val + temp1[temp1$Level == "Apply to < 138 (Left LS)", ]$Coefficient[1] * (138-x)}
    if (x > 142) {val = val + temp1[temp1$Level == "Apply to > 142 (Right LS)", ]$Coefficient[1] * (x-142)}
    if (x > 144) {val = val + temp1[temp1$Level == "Apply to > 144 (Right LS)", ]$Coefficient[1] * (x-144)}
  } else if (interval == "3-<6 months") {
    if (x < 132) {val = val + temp1[temp1$Level == "Apply to < 132 (Left LS)", ]$Coefficient[1] * (132-x)}
    if (x < 140) {val = val + temp1[temp1$Level == "Apply to < 140 (Left LS)", ]$Coefficient[1] * (140-x)}
  }
  if (x < 124) {val = val + temp2[temp2$Level == "Apply to < 124 (Left LS)", ]$Coefficient[1] * (124-x)} 
  
  x = wl1$LAB_MELD[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate laboratory MELD"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate laboratory MELD"), ]
  if (interval == "0-<3 months") {
    if (x < 20) {val = val + temp1[temp1$Level == "Apply to < 20 (Left LS)", ]$Coefficient[1] * (20-x)}
    if (x < 25) {val = val + temp1[temp1$Level == "Apply to < 25 (Left LS)", ]$Coefficient[1] * (25-x)}
    if (x > 10) {val = val + temp1[temp1$Level == "Apply to > 10 (Right LS)", ]$Coefficient[1] * (x-10)}
    if (x > 15) {val = val + temp1[temp1$Level == "Apply to > 15 (Right LS)", ]$Coefficient[1] * (x-15)}
    if (x > 35) {val = val + temp1[temp1$Level == "Apply to > 35 (Right LS)", ]$Coefficient[1] * (x-35)}
  } else if (interval == "3-<6 months") {
    if (x < 15) {val = val + temp1[temp1$Level == "Apply to < 15 (Left LS)", ]$Coefficient[1] * (15-x)}
    if (x < 20) {val = val + temp1[temp1$Level == "Apply to < 20 (Left LS)", ]$Coefficient[1] * (20-x)}
    if (x > 5) {val = val + temp1[temp1$Level == "Apply to > 5 (Right LS)", ]$Coefficient[1] * (x-5)}
  } else if (interval == "6-<12 months") {
    if (x < 20) {val = val + temp1[temp1$Level == "Apply to < 20 (Left LS)", ]$Coefficient[1] * (20-x)}
  }
  if (x < 10) {val = val + temp2[temp2$Level == "Apply to < 10 (Left LS)", ]$Coefficient[1] * (10-x)} 
  
  # x = wl1$CAN_PREV_HL[i]
  # temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate was also listed for heart-lung transplant"), ]
  # temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate was also listed for heart-lung transplant"), ]
  # if (interval == "0-<3 months") {
  #   if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  # }
  # if (x == 1) {val = val + temp2[temp2$Level == "Yes", ]$Coefficient[1]}
  # 
  # x = wl1$CAN_PREV_HR[i]
  # temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate was also listed for heart transplant"), ]
  # temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate was also listed for heart transplant"), ]
  # if (interval == "0-<3 months") {
  #   if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  # } else if (interval == "3-<6 months") {
  #   if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  # } else if (interval == "6-<12 months") {
  #   if (x == 1) {val = val + temp1[temp1$Level == "Yes", ]$Coefficient[1]}
  # }
  # if (x == 1) {val = val + temp2[temp2$Level == "Yes", ]$Coefficient[1]}
  
  x = wl1$CAN_LAST_BILI[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate bilirubin"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate bilirubin"), ]
  if (is.na(x)) {x = 3.1}   # Median
  if (interval == "0-<3 months") {
    if (x < 1) {val = val + temp1[temp1$Level == "Apply to < 1 (Left LS)", ]$Coefficient[1] * (1-x)}
    if (x < 2.5) {val = val + temp1[temp1$Level == "Apply to < 2.5 (Left LS)", ]$Coefficient[1] * (2.5-x)}
    if (x > 1.5) {val = val + temp1[temp1$Level == "Apply to > 1.5 (Right LS)", ]$Coefficient[1] * (x-1.5)}
    if (x > 1) {val = val + temp1[temp1$Level == "Apply to > 1 (Right LS)", ]$Coefficient[1] * (x-1)}
    if (x > 4.5) {val = val + temp1[temp1$Level == "Apply to > 4.5 (Right LS)", ]$Coefficient[1] * (x-4.5)}
    if (x > 5) {val = val + temp1[temp1$Level == "Apply to > 5 (Right LS)", ]$Coefficient[1] * (x-5)}
  } else if (interval == "3-<6 months") {
    if (x < 0.5) {val = val + temp1[temp1$Level == "Apply to < 0.5 (Left LS)", ]$Coefficient[1] * (0.5-x)}
    if (x < 1.5) {val = val + temp1[temp1$Level == "Apply to < 1.5 (Left LS)", ]$Coefficient[1] * (1.5-x)}
    if (x > 4) {val = val + temp1[temp1$Level == "Apply to > 4 (Right LS)", ]$Coefficient[1] * (x-4)}
  } else if (interval == "6-<12 months") {
    if (x < 0.5) {val = val + temp1[temp1$Level == "Apply to < 0.5 (Left LS)", ]$Coefficient[1] * (0.5-x)}
    if (x < 1) {val = val + temp1[temp1$Level == "Apply to < 1 (Left LS)", ]$Coefficient[1] * (1-x)}
    if (x > 2.5) {val = val + temp1[temp1$Level == "Apply to > 2.5 (Right LS)", ]$Coefficient[1] * (x-2.5)}
    if (x > 3.5) {val = val + temp1[temp1$Level == "Apply to > 3.5 (Right LS)", ]$Coefficient[1] * (x-3.5)}
  }
  if (x < 1) {val = val + temp2[temp2$Level == "Apply to < 1 (Left LS)", ]$Coefficient[1] * (1-x)} 
  if (x > 1) {val = val + temp2[temp2$Level == "Apply to > 1 (Right LS)", ]$Coefficient[1] * (x-1)}
  
  x = wl1$CAN_LAST_INR[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate INR"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate INR"), ]
  if (is.na(x)) {x = 1.5}   # Median
  if (interval == "0-<3 months") {
    if (x < 0.4) {val = val + temp1[temp1$Level == "Apply to < 0.4 (Left LS)", ]$Coefficient[1] * (0.4-x)}
    if (x < 0.6) {val = val + temp1[temp1$Level == "Apply to < 0.6 (Left LS)", ]$Coefficient[1] * (0.6-x)}
    if (x > 0.2) {val = val + temp1[temp1$Level == "Apply to > 0.2 (Right LS)", ]$Coefficient[1] * (x-0.2)}
    if (x > 2) {val = val + temp1[temp1$Level == "Apply to > 2 (Right LS)", ]$Coefficient[1] * (x-2)}
  } else if (interval == "3-<6 months") {
    if (x < 0.4) {val = val + temp1[temp1$Level == "Apply to < 0.4 (Left LS)", ]$Coefficient[1] * (0.4-x)}
    if (x > 1) {val = val + temp1[temp1$Level == "Apply to > 1 (Right LS)", ]$Coefficient[1] * (x-1)}
  } else if (interval == "6-<12 months") {
    if (x > 0.8) {val = val + temp1[temp1$Level == "Apply to > 0.8 (Right LS)", ]$Coefficient[1] * (x-0.8)}
    if (x > 1) {val = val + temp1[temp1$Level == "Apply to > 1 (Right LS)", ]$Coefficient[1] * (x-1)}
  }
  if (x < 1.4) {val = val + temp2[temp2$Level == "Apply to < 1.4 (Left LS)", ]$Coefficient[1] * (1.4-x)}
  if (x < 1.6) {val = val + temp2[temp2$Level == "Apply to < 1.6 (Left LS)", ]$Coefficient[1] * (1.6-x)} 
  if (x > 0.2) {val = val + temp2[temp2$Level == "Apply to > 0.2 (Right LS)", ]$Coefficient[1] * (x-0.2)}
  
  x = wl1$CAN_LAST_SERUM_CREAT[i]
  temp1 = df_INTERVAL[(df_INTERVAL$Element == "Candidate serum creatinine"), ]
  temp2 = df_OVERALL[(df_OVERALL$Element == "Candidate serum creatinine"), ]
  if (is.na(x)) {x = 1.010}   # Median
  if (interval == "0-<3 months") {
    if (x < 0.8) {val = val + temp1[temp1$Level == "Apply to < 0.8 (Left LS)", ]$Coefficient[1] * (0.8-x)}
    if (x > 1.6) {val = val + temp1[temp1$Level == "Apply to > 1.6 (Right LS)", ]$Coefficient[1] * (x-1.6)}
    if (x > 1.8) {val = val + temp1[temp1$Level == "Apply to > 1.8 (Right LS)", ]$Coefficient[1] * (x-1.8)}
    if (x > 2.6) {val = val + temp1[temp1$Level == "Apply to > 2.6 (Right LS)", ]$Coefficient[1] * (x-2.6)}
    if (x > 3) {val = val + temp1[temp1$Level == "Apply to > 3 (Right LS)", ]$Coefficient[1] * (x-3)}
  } else if (interval == "6-<12 months") {
    if (x < 0.8) {val = val + temp1[temp1$Level == "Apply to < 0.8 (Left LS)", ]$Coefficient[1] * (0.8-x)}
    if (x > 0.6) {val = val + temp1[temp1$Level == "Apply to > 0.6 (Right LS)", ]$Coefficient[1] * (x-0.6)}
  }
  if (x < 1.6) {val = val + temp2[temp2$Level == "Apply to < 1.6 (Left LS)", ]$Coefficient[1] * (1.6-x)} 
  
  # temp1 = df_INTERVAL[(df_INTERVAL$Element == "Kilometers between candidate ZIP code and hospital"), ]
  # temp2 = df_OVERALL[(df_OVERALL$Element == "Kilometers between candidate ZIP code and hospital"), ]

  return (exp(val))
}
```

```{r}
temp = wl1#[1:10000, ]
# interval can be: "Overall", "0-<3 months", "3-<6 months", "6-<12 months"
temp$cum_hr = sapply(c(1:nrow(temp)), function(i) {3/12*haz_ratio_WL_S1(temp, i, WL_hr_coeff_src, "0-<3 months") + 
    3/12*haz_ratio_WL_S1(temp, i, WL_hr_coeff_src, "3-<6 months") + 6/12*haz_ratio_WL_S1(temp, i, WL_hr_coeff_src, "6-<12 months")})

summary(temp$cum_hr)

wl1 = temp

S0 = exp(- exp(-9.229455))   # = exp{- Cumulative hazard}
wl1$WL_S1 = S0^wl1$cum_hr    # Waiting list survival at the end of 1 year! (Includes due to transplantations)

quantile(wl1$cum_hr, 0.99)
summary(wl1$WL_S1); summary(wl1$cum_hr); cor(wl1[wl1$cum_hr <= quantile(wl1$cum_hr, 0.999), ]$WL_S1, wl1[wl1$cum_hr <= quantile(wl1$cum_hr, 0.999), ]$cum_hr)
```

# Regressing 'cum_hr':
```{r}
m = lm(cum_hr ~ CAN_AGE_AT_LISTING + LAB_MELD + CAN_LIFE_SUPPORT, wl1[wl1$cum_hr <= quantile(wl1$cum_hr, 0.99), ])  # Signs are as expected!
m = lm(WL_S1 ~ CAN_AGE_AT_LISTING + LAB_MELD + CAN_LIFE_SUPPORT, wl1[wl1$cum_hr <= quantile(wl1$cum_hr, 0.99), ])  # Signs are as expected!
summary(m)

# Adding "new_PTR_STAT_CD_desp + rec_age_type + rec_life_sup + rec_med_cond":
wl1$rec_age_type = "RA3"      # Recipient with age >=65
wl1[(wl1$CAN_AGE_AT_LISTING < 45), "rec_age_type"] = "RA1"
wl1[(wl1$CAN_AGE_AT_LISTING >= 45) & (wl1$CAN_AGE_AT_LISTING < 65), "rec_age_type"] = "RA2"

wl1$rec_life_sup = "No"
wl1[(wl1$CAN_LIFE_SUPPORT == "Y"), "rec_life_sup"] = "Yes"

temp = wl1
temp = temp[(!is.na(temp$CAN_MED_COND)) & (temp$cum_hr <= quantile(temp$cum_hr, 0.99)), ]
temp$rec_med_cond = "NH"    # Missing is treated as 'not-hospitalized' in graft survival model of SRTR (See HZ coefficients)
temp[(temp$CAN_MED_COND == 2), "rec_med_cond"] = "H"
temp[(temp$CAN_MED_COND == 1), "rec_med_cond"] = "ICU"

temp$new_PTR_STAT_CD_desp = "MELD 6-14"
temp[(temp$LAB_MELD >= 15) & (temp$LAB_MELD <= 28), "new_PTR_STAT_CD_desp"] = "MELD 15-28"
temp[(temp$LAB_MELD >= 29) & (temp$LAB_MELD <= 32), "new_PTR_STAT_CD_desp"] = "MELD 29-32"
temp[(temp$LAB_MELD >= 33) & (temp$LAB_MELD <= 34), "new_PTR_STAT_CD_desp"] = "MELD 33-34"
temp[(temp$LAB_MELD >= 35) & (temp$LAB_MELD <= 36), "new_PTR_STAT_CD_desp"] = "MELD 35-36"
temp[(temp$LAB_MELD > 36), "new_PTR_STAT_CD_desp"] = "MELD >36"

# Regressing Waiting list surivial probability using factors used in 'policy simulations':
m = lm(WL_S1 ~ new_PTR_STAT_CD_desp + rec_age_type + rec_life_sup + rec_med_cond, temp)
summary(m)
```

# Write the files:
```{r}
write.csv(wl1[, c("PX_ID", "cum_hr", "WL_S1")], paste0(fol_, "/Analysis/wl1_survival.csv"), row.names = F)
wl1_survival = read.csv(paste0(fol_, "/Analysis/wl1_survival.csv"), stringsAsFactors = F)
```

# Comparing "Waiting list surival" between policies: Does not CORRELATE well with c/d ration, or change in p_acpt!
## With Share 35, "WL_S1" decreaseD, meaning that Patients with lesser survival prob. got transplanted, which makes sense!
```{r}
match1_src = merge(df2, wl1[, c("PX_ID", "cum_hr", "WL_S1")], by = "PX_ID", all.x = T)

summary(match1_src$GSi - match1_src$WL_S1)

summary(match1_src$cum_hr)
# cond = (match1_src$cum_hr <= quantile(match1_src$cum_hr, 0.99))   # Removing the outliers:
# temp = data.table(match1_src)[, list(mean_cum_hr = mean(cum_hr, na.rm = T), mean_WL_S1 = mean(WL_S1, na.rm = T)), by = list(CAN_OPO_REGION, policy)]

cond_Y = (match1_src$PTR_OFFER_ACPT == "N")
temp = data.table(match1_src[cond_Y, ])[, list(mean_WL_S1 = mean(WL_S1, na.rm = T)), by = list(CAN_OPO_REGION, policy)]
temp1 = as.data.frame(dcast(temp, CAN_OPO_REGION ~ policy, value.var = "mean_WL_S1"))
temp1$diff = temp1$post - temp1$pre

write.csv(temp1, "/Users/sakshat/Desktop/temp.csv", row.names = F)

# 

```

# Comparing 'Statistics' of WL mortality (Pre-/Post-):
```{r}
min(wl1$list_date); max(wl1$list_date)
sort(table(wl1$CAN_REM_CD)); sum(is.na(wl1$CAN_REM_CD))

# Not appropirate since 'pre-' patients have LONGER obseervation period!
temp = data.table(wl1)[, list(cnt = .N, died_p = sum(CAN_REM_CD == 8, na.rm = T)/.N), by = list(policy)]   

pre_PX = subset(wl1, policy == "pre")$PX_ID
post_PX = subset(wl1, policy == "post")$PX_ID

# Load 'MELD transition' file:
agg_level = "G6AC"; MELD_col_name = "CANHX_STAT_CD"
trans = read.csv(paste0(fol_, "/Analysis/Transition_matrix/", agg_level, "/", MELD_col_name,  "/stathist_liin_nxt_state_time_adj_", agg_level, "_", MELD_col_name, ".csv"))

# Consider only "Adult patients":
trans = subset(trans, pat_type == "adult")
trans$CANHX_BEGIN_DT = as.Date(trans$CANHX_BEGIN_DT)
trans$CAN_LISTING_DT = as.Date(trans$CAN_LISTING_DT)
trans$CAN_REM_DT = as.Date(trans$CAN_REM_DT)

trans$policy = sapply(c(1:nrow(trans)), function(i) {if (trans$CAN_LISTING_DT[i] > "2013-06-17") {return ("post")} else {return ("pre")}}) 
table(trans$policy)

# Equal time periods for pre-/post-:
difftime(as.Date("2013-06-17", format= "%Y-%m-%d"), as.Date("2010-01-01", format= "%Y-%m-%d"), "days")   # 1263 days
difftime(as.Date("2016-12-01", format= "%Y-%m-%d"), as.Date("2013-06-17", format= "%Y-%m-%d"), "days")   # 1263 days
trans1 = subset(trans, (CAN_LISTING_DT >= "2010-01-01") & CAN_LISTING_DT <= "2016-12-01")
trans1 = subset(trans1, ((policy == "pre") & (CANHX_BEGIN_DT < "2013-06-17")) | ((policy == "post") & (CANHX_BEGIN_DT < "2016-12-01")))

sort(table(trans1$CAN_REM_CD_desp)); sum(is.na(trans1$CAN_REM_CD_desp))

temp = data.table(trans1)[, list(cnt = .N, died = ifelse(sum(CAN_REM_CD_desp == "Died", na.rm = T) > 1, 1, 0)), by = list(PX_ID, policy, CAN_OPO_CD)]   # CAN_OPO_REGION, "Candidate condition deteriorated , too sick for tx
temp1 = data.table(temp)[, list(cnt = .N, died_p = sum(died)/.N), by = list(policy)]   
# Aggregated WL 'mortality rate' did DECREASE from 12.0% to 9.4%!

temp1 = data.table(temp)[, list(cnt = .N, died_p = sum(died)/.N), by = list(policy, CAN_OPO_CD)]   # CAN_OPO_REGION, CAN_OPO_CD   
temp1 = as.data.frame(dcast(temp1, CAN_OPO_CD ~ policy, value.var = "died_p"))

sd(temp1[!is.na(temp1$CAN_OPO_CD), ]$pre); sd(temp1[!is.na(temp1$CAN_OPO_CD), ]$post)
# Standard deviation of 'mortality rates' also REDUCED across the DSAs (and also across the Regions)!

# write.csv(temp1, "/Users/sakshat/Desktop/temp.csv", row.names = F)
```

# Comparing 'Statistics' of TX quality, and Waiting time till transplant (Pre-/Post-):
```{r}
# 1. Discard rates:
## As per paper "The Impact of Broader Regional Sharing of Livers: 2-Year Results of Share 35", Share 35 resulted in less discards (see page 402, 403)

# 2. Waiting time (till transplant):
trans_tx = subset(trans1, CAN_REM_CD_desp %in% c("Deceased Donor tx, removed by transplanting center", "Transplant at another center (multi-listed)"))
trans_tx = subset(trans_tx, ((policy == "pre") & (CAN_REM_DT < "2013-06-17")) | ((policy == "post") & (CAN_REM_DT < "2016-12-01")))

temp = data.table(trans_tx)[, list(cnt = .N, list_date = unique(CAN_LISTING_DT), tx_date = unique(CAN_REM_DT)), by = list(PX_ID, policy, CAN_OPO_CD, CAN_OPO_REGION)]
temp$wait_till_tx = as.numeric(as.Date(temp$tx_date, format= "%Y-%m-%d") - as.Date(temp$list_date, format = "%Y-%m-%d"))

temp1 = data.table(temp)[, list(median_wait_till_tx = median(wait_till_tx), mean_wait_till_tx = mean(wait_till_tx)), by = list(policy)]
 # Median INCREASED from 63 to 66 days; Mean INCREASED from 135.10 to 143.05 days (6%).

temp1 = data.table(temp)[, list(median_wait_till_tx = median(wait_till_tx), mean_wait_till_tx = mean(wait_till_tx)), by = list(policy, CAN_OPO_REGION)]   # CAN_OPO_REGION, CAN_OPO_CD
temp1 = as.data.frame(dcast(temp1, CAN_OPO_REGION ~ policy, value.var = "median_wait_till_tx"))

sd(temp1$pre); sd(temp1$post)    # sd of median_wait_till_tx across the regions INCREASED from 25.18 to 32.83 (28%)!

# 3. MELD at transplant (Already covered in summary statistics)!
```

# Comparing 'organs' that had MATCH_IDs but had to be discarded (existing lit. says it decreased (from 10.3% to 9.5%)!):
## Source: "The Impact of Broader Regional Sharing of Livers: 2-Year Results of Share 35" paper.
```{r}
df2$date = as.Date(df2$date, format = "%Y-%m-%d")
df3 = subset(df2, (date >= "2010-01-01") & (date <= "2016-12-01")) 

temp = data.table(df3)[, list(cnt_Y = sum(PTR_OFFER_ACPT == "Y")), by = list(DONOR_ID, policy)]

table(temp$policy, temp$cnt_Y)    # But does 'cnt_Y=0' imply that "transplant" actually happenend? Not sure. because the % is 10 times less than what was reported in the paper. 
```

# Summary statistics of 'Acuity Circles' bands:
```{r}
library(readxl)
df_dem = read_excel(paste0(fol_, "/R_files/Equilibrium/Input_data/For_Gurobi/dem_sup.xlsx"), sheet = "dem")
df_sup = read_excel(paste0(fol_, "/R_files/Equilibrium/Input_data/For_Gurobi/dem_sup.xlsx"), sheet = "sup")

# 2015-18:
df_dem$dem = df_dem$`dem_2015-18`
df_sup$sup = df_sup$`sup_2015-18`
sum(df_sup$sup)/sum(df_dem$dem)

df_dem = df_dem[df_dem$dem > 0, ]
df_sup = df_sup[df_sup$sup > 0, c("don_hosp_id", "don_DSA", "don_Region", "sup")]

# Distance matrix:
df_donor_trnspl_dist = read.csv(paste0(fol_, '/Analysis/dist_matrix_don_hosp_txc.csv'), stringsAsFactors = F)

# Only Donor hospitals which have >0 supply:
df_donor_trnspl_dist = df_donor_trnspl_dist[(df_donor_trnspl_dist$X__1 %in% df_sup$don_hosp_id), ]

# Only TCs which have >0 demand:
df_donor_trnspl_dist = df_donor_trnspl_dist[, c(1, which(colnames(df_donor_trnspl_dist) %in% df_dem$transplant_center))]

# Count of TCs (and demand) in different circular bands:
df_sup$first_band_TC_cnt = sapply(c(1:nrow(df_sup)), function(x) {sum(df_donor_trnspl_dist[x, -1] <= 150 * 1.609 * 1.15078)})
df_sup$second_band_TC_cnt = sapply(c(1:nrow(df_sup)), function(x) {sum(df_donor_trnspl_dist[x, -1] <= 250 * 1.609 * 1.15078)})
df_sup$third_band_TC_cnt = sapply(c(1:nrow(df_sup)), function(x) {sum(df_donor_trnspl_dist[x, -1] <= 500 * 1.609 * 1.15078)})
df_sup$third_band_TC_cnt = df_sup$third_band_TC_cnt - df_sup$second_band_TC_cnt
df_sup$second_band_TC_cnt = df_sup$second_band_TC_cnt - df_sup$first_band_TC_cnt

f = function(don_hosp, radius) {
  temp = df_donor_trnspl_dist[df_donor_trnspl_dist$X__1 == don_hosp, ]
  temp = as.data.frame(t(temp)[-1, ])
  colnames(temp)[1] = "v1"; temp$TC = row.names(temp); temp$v1 = as.numeric(as.character(temp$v1))
  temp = temp[temp$v1 <= radius * 1.609 * 1.15078, ]
  
  tot_TC_dem = sum(df_dem[df_dem$transplant_center %in% temp$TC, ]$dem)
  return (tot_TC_dem)
}

# temp = lapply(df_sup$don_hosp_id, f, radius = 150)
  
df_sup$first_band_TC_dem = unlist(lapply(df_sup$don_hosp_id, f, radius = 150))
df_sup$second_band_TC_dem = unlist(lapply(df_sup$don_hosp_id, f, radius = 250))
df_sup$third_band_TC_dem = unlist(lapply(df_sup$don_hosp_id, f, radius = 500))
df_sup$third_band_TC_dem = df_sup$third_band_TC_dem - df_sup$second_band_TC_dem
df_sup$second_band_TC_dem = df_sup$second_band_TC_dem - df_sup$first_band_TC_dem


# Summary statistics:
## TC_cnt: 
summary(df_sup$first_band_TC_cnt)
summary(df_sup$second_band_TC_cnt)
summary(df_sup$third_band_TC_cnt)

## TC_dem:
summary(df_sup$first_band_TC_dem)
summary(df_sup$second_band_TC_dem)
summary(df_sup$third_band_TC_dem)

## Supply:
summary(df_sup$sup)

# Box-plots:
# library(RColorBrewer)
myColors = c('#619CFF', '#00BA38', "#F8766D")

temp <- melt(df_sup, id.vars = 'don_hosp_id', measure.vars = c('first_band_TC_cnt', 'second_band_TC_cnt', 'third_band_TC_cnt'))
temp$variable = sapply(as.character(temp$variable), function(i) {substr(i, 1, nchar(i)-7)})

names(myColors) <- levels(temp$variable)
colScale <- scale_colour_manual(name = "variable",values = myColors)
ggplot(temp, aes(x = variable, y=value, color=variable)) +
    geom_boxplot() + labs(x = "Circular bands", y = "Count of TCs (around a Donor Hospital)") + theme_classic(base_size = 15) + colScale

temp <- melt(df_sup, id.vars = 'don_hosp_id', measure.vars = c('first_band_TC_dem', 'second_band_TC_dem', 'third_band_TC_dem'))
temp$variable = sapply(as.character(temp$variable), function(i) {substr(i, 1, nchar(i)-7)})

names(myColors) <- levels(temp$variable)
colScale <- scale_colour_manual(name = "variable",values = myColors)
ggplot(temp, aes(x = variable, y=value, color=variable)) +
    geom_boxplot() + labs(x = "Circular bands", y = "Demand at TCs (around a Donor Hospital)") + theme_classic(base_size = 15) + colScale


```










