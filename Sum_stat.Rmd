
```{r}
library(data.table)
library(readxl)
library(openxlsx)
library(ggplot2)
library(maptools)
library(foreign)
library(plyr)
library(haven)
```

```{r}
knitr::opts_knit$set(root.dir = normalizePath("/Volumes/GoogleDrive/My Drive/SRTR/R_files/qw/"))
getwd()
```
Organ Arrival (Donor):
```{r}
don = read.csv("/Volumes/GoogleDrive/My Drive/SRTR/Analysis/donor.csv")
don$date <- as.Date(don$date, format= "%Y-%m-%d")
don$yr = substr(don$date, 1, 4)
names(don)
don$date[2]

temp = data.table(don)[, list(organ_per_month = .N/uniqueN(yr_mon)), by = list(yr_mon)]
temp = data.table(don)[, list(organ_per_month = .N/uniqueN(yr_mon)), by = list(yr)]
plot(temp[, 1], temp$organ_per_month)
#write.xlsx(temp, "/Users/sakshat/Google Drive/SRTR/Analysis/don_sum.xlsx", sheetName="Sheet1")
```

```{r}
df_src = read.csv("/Volumes/GoogleDrive/My Drive/SRTR/Analysis/match_not_B_NA_MATCH_seq_PTR_upd_CAN_DON_info.csv")
df = df_src
names(df)

# df$DON_ABO = as.character(df$DON_ABO)
# df$DON_ABO = gsub("b'", "", df$DON_ABO)
# df$DON_ABO = gsub("'", "", df$DON_ABO)

table(unique(df[, c("DONOR_ID", "DON_ABO")])$DON_ABO) / uniqueN(df$DONOR_ID)
table(unique(df[, c("PX_ID", "CAN_ABO")])$CAN_ABO) / uniqueN(df$PX_ID)
```
Checking blood compatibility:
```{r}
sum(!is.na(df$CAN_ABO != df$DON_ABO)) / nrow(df)
df$blood_comp = NA
df[!is.na(df$CAN_ABO) & !is.na(df$DON_ABO) & (df$CAN_ABO == df$DON_ABO), "blood_comp"] = "I"  # ~70% offers
df[is.na(df$CAN_ABO) | is.na(df$DON_ABO), "blood_comp"] = "No_info"   #~1.7% offers
table(df$blood_comp) / nrow(df)
```

To cross-check the SHARE 35 policy:
```{r}
samp = subset(df, MATCH_ID == "587165")
samp = samp[, c("PTR_SEQUENCE_NUM_upd", "CAN_ABO", "DON_ABO", "sharing", "policy")]

meld_lst = c("MELD/PELD 35", "MELD/PELD 36", "MELD/PELD 37", "MELD/PELD 38", "MELD/PELD 39", "MELD/PELD 40", "Status 1A", "Status 1B")
df_35 = subset(df, PTR_STAT_CD_desp %in% meld_lst)
table(df_35$blood_comp) / nrow(df_35)
table(df_35[df_35$policy == "post", ]$blood_comp) / nrow(df_35[df_35$policy == "post", ])

temp = data.table(df_35)[, list(avg_SEQ = mean(PTR_SEQUENCE_NUM_upd)), by = list(policy, sharing)]

# To check if no patient of the same DSA was offered the organ before another regional patient (from a different DSA) with a higher MELD:
df_post = subset(df[, c("DONOR_ID", "MATCH_ID", "PTR_SEQUENCE_NUM", "PTR_SEQUENCE_NUM_upd", "PTR_STAT_CD_desp", "policy", "CAN_ABO", "DON_ABO", "blood_comp", "sharing")], (policy == "post") & (PTR_SEQUENCE_NUM_upd <=50))
table(df_post$blood_comp) / nrow(df_post)

df_post$MELD = sapply(df_post$PTR_STAT_CD_desp, function(x) {MELD_mod(x)})

samp = subset(df_post, MATCH_ID == "787765")

temp = data.table(subset(df_post, (PTR_STAT_CD_desp %in% meld_lst) & (sharing == "regional")))[, list(max_SEQ_reg_high_MELD = max(PTR_SEQUENCE_NUM_upd)), by = MATCH_ID]

temp$min_MELD_local = NA
for (i in c(1:nrow(temp))) {
  temp1 = subset(df_post, (MATCH_ID == temp$MATCH_ID[i]) & (PTR_SEQUENCE_NUM_upd <= temp$max_SEQ_reg_high_MELD[i]) & (sharing == "local"))
  if (nrow(temp1) > 0) {
    temp$min_MELD_local[i] = min(temp1$MELD)
  }
}

prob = subset(temp, min_MELD_local < 35)

```

Patient B (Regional pat. higher MELD) was always offered the organ before A (local pat., lesser MELD):
```{r}
prob_MATCH_IDs = c()    # Problematic MATCH_IDs:
# SEQ_NUM*: Regional patients with MELD >= 40:
temp = data.table(subset(df_post, (MELD >= 40) & (sharing == "regional")))[, list(max_SEQ_reg_high_MELD = max(PTR_SEQUENCE_NUM_upd)), by = MATCH_ID]
temp$min_MELD_loc = NA
for (i in c(1:nrow(temp))) {
  temp1 = subset(df_post, (MATCH_ID == temp$MATCH_ID[i]) & (PTR_SEQUENCE_NUM_upd <= temp$max_SEQ_reg_high_MELD[i]) & (sharing == "local"))
  if (nrow(temp1) > 0) {
    temp$min_MELD_loc[i] = min(temp1$MELD)
  }
}
nrow(subset(temp, min_MELD_loc < 40)); nrow(subset(temp, min_MELD_loc < 40)) / nrow(temp)
prob_MATCH_IDs = c(prob_MATCH_IDs, subset(temp, (min_MELD_loc < 40))$MATCH_ID)

# SEQ_NUM*: Regional patients with MELD >= 39:
temp = data.table(subset(df_post, (MELD >= 39) & (sharing == "regional")))[, list(max_SEQ_reg_high_MELD = max(PTR_SEQUENCE_NUM_upd)), by = MATCH_ID]
temp$min_MELD_loc = NA
for (i in c(1:nrow(temp))) {
  temp1 = subset(df_post, (MATCH_ID == temp$MATCH_ID[i]) & (PTR_SEQUENCE_NUM_upd <= temp$max_SEQ_reg_high_MELD[i]) & (sharing == "local"))
  if (nrow(temp1) > 0) {
    temp$min_MELD_loc[i] = min(temp1$MELD)
  }
}
nrow(subset(temp, min_MELD_loc < 39)); nrow(subset(temp, min_MELD_loc < 39)) / nrow(temp)
prob_MATCH_IDs = c(prob_MATCH_IDs, subset(temp, (min_MELD_loc < 39))$MATCH_ID)

# SEQ_NUM*: Regional patients with MELD >= 38:
temp = data.table(subset(df_post, (MELD >= 38) & (sharing == "regional")))[, list(max_SEQ_reg_high_MELD = max(PTR_SEQUENCE_NUM_upd)), by = MATCH_ID]
temp$min_MELD_loc = NA
for (i in c(1:nrow(temp))) {
  temp1 = subset(df_post, (MATCH_ID == temp$MATCH_ID[i]) & (PTR_SEQUENCE_NUM_upd <= temp$max_SEQ_reg_high_MELD[i]) & (sharing == "local"))
  if (nrow(temp1) > 0) {
    temp$min_MELD_loc[i] = min(temp1$MELD)
  }
}
nrow(subset(temp, min_MELD_loc < 38)); nrow(subset(temp, min_MELD_loc < 38)) / nrow(temp)
prob_MATCH_IDs = c(prob_MATCH_IDs, subset(temp, (min_MELD_loc < 38))$MATCH_ID)

# SEQ_NUM*: Regional patients with MELD >= 37:
temp = data.table(subset(df_post, (MELD >= 37) & (sharing == "regional")))[, list(max_SEQ_reg_high_MELD = max(PTR_SEQUENCE_NUM_upd)), by = MATCH_ID]
temp$min_MELD_loc = NA
for (i in c(1:nrow(temp))) {
  temp1 = subset(df_post, (MATCH_ID == temp$MATCH_ID[i]) & (PTR_SEQUENCE_NUM_upd <= temp$max_SEQ_reg_high_MELD[i]) & (sharing == "local"))
  if (nrow(temp1) > 0) {
    temp$min_MELD_loc[i] = min(temp1$MELD)
  }
}
nrow(subset(temp, min_MELD_loc < 37)); nrow(subset(temp, min_MELD_loc < 37)) / nrow(temp)
prob_MATCH_IDs = c(prob_MATCH_IDs, subset(temp, (min_MELD_loc < 37))$MATCH_ID)

# SEQ_NUM*: Regional patients with MELD >= 36:
temp = data.table(subset(df_post, (MELD >= 36) & (sharing == "regional")))[, list(max_SEQ_reg_high_MELD = max(PTR_SEQUENCE_NUM_upd)), by = MATCH_ID]
temp$min_MELD_loc = NA
for (i in c(1:nrow(temp))) {
  temp1 = subset(df_post, (MATCH_ID == temp$MATCH_ID[i]) & (PTR_SEQUENCE_NUM_upd <= temp$max_SEQ_reg_high_MELD[i]) & (sharing == "local"))
  if (nrow(temp1) > 0) {
    temp$min_MELD_loc[i] = min(temp1$MELD)
  }
}
nrow(subset(temp, min_MELD_loc < 36)); nrow(subset(temp, min_MELD_loc < 36)) / nrow(temp)
prob_MATCH_IDs = c(prob_MATCH_IDs, subset(temp, (min_MELD_loc < 36))$MATCH_ID)

# SEQ_NUM*: Regional patients with MELD >= 35:
temp = data.table(subset(df_post, (MELD >= 35) & (sharing == "regional")))[, list(max_SEQ_reg_high_MELD = max(PTR_SEQUENCE_NUM_upd)), by = MATCH_ID]
temp$min_MELD_loc = NA
for (i in c(1:nrow(temp))) {
  temp1 = subset(df_post, (MATCH_ID == temp$MATCH_ID[i]) & (PTR_SEQUENCE_NUM_upd <= temp$max_SEQ_reg_high_MELD[i]) & (sharing == "local"))
  if (nrow(temp1) > 0) {
    temp$min_MELD_loc[i] = min(temp1$MELD)
  }
}
nrow(subset(temp, min_MELD_loc < 35)); nrow(subset(temp, min_MELD_loc < 35)) / nrow(temp)
prob_MATCH_IDs = c(prob_MATCH_IDs, subset(temp, (min_MELD_loc < 35))$MATCH_ID)
#prob_MATCH_IDs = subset(temp, (min_MELD_loc < 35))
```

```{r}
# To see if the problematic MATCH_IDs are from DONORS < 17 yrs old:
prob_MATCH_IDs = unique(prob_MATCH_IDs)

temp1 = subset(df, MATCH_ID %in% prob_MATCH_IDs)
temp2 = unique(temp1[, c("MATCH_ID", "DONOR_ID", "DON_AGE_IN_MONTHS")])
uniqueN(temp1$DONOR_ID)
nrow(temp1)/nrow(df)

hist(unique(temp1[, c("DONOR_ID", "DON_AGE_IN_MONTHS")])$DON_AGE_IN_MONTHS)
uniqueN(temp1[temp1$DON_AGE_IN_MONTHS >= 17*12, "DONOR_ID"]) / uniqueN(temp1$DONOR_ID)   # 84% of the donors were <17 yrs old

cols = c("DONOR_ID", "DON_AGE_IN_MONTHS", "CAN_AGE_IN_MONTHS_AT_LISTING", "PX_ID", "MATCH_ID", "yr_mon", "PTR_SEQUENCE_NUM_upd", "MATCH_seq_Y1", "sharing", "PTR_STAT_CD_desp", "DON_WGT_KG", "CAN_MAX_WGT", "blood_comp")

samp = subset(df[, cols], MATCH_ID == "1040968")
```

```{r}
names(df)
hist(unique(df[, c("DONOR_ID", "DON_AGE_IN_MONTHS")])$DON_AGE_IN_MONTHS)
uniqueN(df[df$DON_AGE_IN_MONTHS <= 18*12, "DONOR_ID"]) / uniqueN(df$DONOR_ID)

# MATCH for donors >17 and <18 yrs old:
df_mid = subset(df, (DON_AGE_IN_MONTHS < 18*12) & (DON_AGE_IN_MONTHS > 17*12) & (policy == "post"))
unique(df_mid$MATCH_ID)
samp = subset(df[, cols], MATCH_ID == "822882")
```

To check if MELD 35 patients became more aggressive, and 39 less aggressive:
Approach 3: (Patient-level analysis)
```{r}
table(df$CAN_LIVING_DON_TX); table(df$CAN_SOURCE)
uniqueN(df$PX_ID)
df1 = subset(df, (policy == "pre")); uniqueN(df1$PX_ID)

df2 = subset(df, (policy == "post") & !(PX_ID %in% df1$PX_ID)); uniqueN(df2$PX_ID)    # Only consider PX_ID who joined after June'13

samp = subset(df1, PX_ID == 715611)
table(samp$PTR_OFFER_ACPT)
samp[samp$PTR_OFFER_ACPT == "Y", ]

f1 = function(col1, col2) {
  temp = data.frame(PTR_OFFER_ACPT = col1, PTR_STAT_CD_desp = col2)
  temp = subset(temp, PTR_OFFER_ACPT == "Y")
  if (nrow(temp) > 0) {
    return(temp$PTR_STAT_CD_desp[1])
  }
}
f1(samp$PTR_OFFER_ACPT, samp$PTR_STAT_CD_desp)

temp1 = data.table(df1)[, list(region = unique(CAN_OPO_REGION), reject_cnt = sum(PTR_OFFER_ACPT == "N"), accept = sum(PTR_OFFER_ACPT == "Y"), MELD_accept = f1(PTR_OFFER_ACPT, PTR_STAT_CD_desp)), by = PX_ID]; temp1$policy = "pre"

temp2 = data.table(df2)[, list(region = unique(CAN_OPO_REGION), reject_cnt = sum(PTR_OFFER_ACPT == "N"), accept = sum(PTR_OFFER_ACPT == "Y"), MELD_accept = f1(PTR_OFFER_ACPT, PTR_STAT_CD_desp)), by = PX_ID]; temp2$policy = "post"

write.xlsx(rbind(temp1, temp2), "/Volumes/GoogleDrive/My Drive/SRTR/Analysis/pat_lvl_rej.xlsx", sheetName="pat_lvl_rej")
```

Approach 2: (For every organ, how many offers were rejected by MELD 35, 36, ..., 40 patients)
```{r}

temp1 = data.table(subset(df1, PTR_OFFER_ACPT == "N"))[, list(cnt_35 = sum(PTR_STAT_CD_desp == "MELD/PELD 35"), cnt_36 = sum(PTR_STAT_CD_desp == "MELD/PELD 36"), 
                                                              cnt_37 = sum(PTR_STAT_CD_desp == "MELD/PELD 37"), cnt_38 = sum(PTR_STAT_CD_desp == "MELD/PELD 38"), 
                                                              cnt_39 = sum(PTR_STAT_CD_desp == "MELD/PELD 39"), cnt_40 = sum(PTR_STAT_CD_desp == "MELD/PELD 40")), by = list(CAN_OPO_REGION, policy)]

temp2 = data.table(subset(df2, PTR_OFFER_ACPT == "N"))[, list(cnt_35 = sum(PTR_STAT_CD_desp == "MELD/PELD 35"), cnt_36 = sum(PTR_STAT_CD_desp == "MELD/PELD 36"), 
                                                              cnt_37 = sum(PTR_STAT_CD_desp == "MELD/PELD 37"), cnt_38 = sum(PTR_STAT_CD_desp == "MELD/PELD 38"), 
                                                              cnt_39 = sum(PTR_STAT_CD_desp == "MELD/PELD 39"), cnt_40 = sum(PTR_STAT_CD_desp == "MELD/PELD 40")), by = list(CAN_OPO_REGION, policy)]
hist(temp1$cnt_40)
write.csv(rbind(temp1, temp2), "/Volumes/GoogleDrive/My Drive/SRTR/Analysis/test.csv", row.names = F) # Merged to "pat_lvl_rej.xlsx" file.
```

Exploring Waiting list candidates (DEMAND):
```{r}
wl = read.csv("/Volumes/GoogleDrive/My Drive/SRTR/Analysis/waitlist.csv")
tx = read.csv("/Volumes/GoogleDrive/My Drive/SRTR/Analysis/tx.csv")
txf = read.csv("/Volumes/GoogleDrive/My Drive/SRTR/Analysis/txf_recent.csv")
#txf = read.csv("/Users/shubhamakshat/Google Drive/SRTR/Analysis/txf_recent.csv")
```

```{r}
names(wl)
```

```{r}
wl$list_date = as.Date(wl$list_date, format= "%Y-%m-%d")
min(wl$list_date); max(wl$list_date)
wl1= wl[wl$list_date > "2010-01-01", ]

wl1$policy = sapply(c(1:nrow(wl1)), function(i) {if (wl1$list_date[i] > "2013-06-17") {return ("post")} else {return ("pre")}}) 

# DEFINE MELDS TO REMOVE MORE AGAIN, LOOKING MORE CAREFULLY
# Ignore recods with MELD/PELD < 6, and set MELD as 41 for Status 1A, 1B:
rem_MELD = c("MELD/PELD -1", "MELD/PELD -2", "MELD/PELD -3", "MELD/PELD -4", "MELD/PELD -5", "MELD/PELD -6", "MELD/PELD -7", "MELD/PELD -8", "MELD/PELD -9", "MELD/PELD -10", "MELD/PELD -11", "MELD/PELD -12", "MELD/PELD 0", "MELD/PELD 1", "MELD/PELD 2", "MELD/PELD 3", "MELD/PELD 4", "MELD/PELD 5", "Status 2A", "Status 2B", "Status 3", "Temporarily Inactive", "Old status 2", "Old status 4")

# Demand trend:
wl$yr_mon = substr(as.character(wl$list_date), 1, 7)
wl$yr = substr(as.character(wl$yr_mon), 1, 4)
temp = data.table(wl)[, list(new_pat_cnt = .N), by = yr]
plot(temp[temp$yr != "2019", ]$yr, temp[temp$yr != "2019", ]$new_pat_cnt, xlab = "yr", ylab = "new_pat_cnt")

wl1$yr_mon = substr(as.character(wl1$list_date), 1, 7)
wl1$yr = substr(as.character(wl1$yr_mon), 1, 4)
temp = data.table(wl1)[, list(new_pat_cnt = .N), by = yr]
plot(temp[temp$yr != "2019", ]$yr, temp[temp$yr != "2019", ]$new_pat_cnt, xlab = "yr", ylab = "new_pat_cnt")

wl1 = wl1[!(wl1$CAN_INIT_STAT_desp %in% rem_MELD), ]  # ~5% records removed!

# Function to set MELD as 41 for Status 1A/1B patients and of those with MELD > 40!
MELD_mod = function(x) {
  temp = strsplit(as.character(x), split = " ")[[1]][2]
  if ((temp == "1A") | (temp == "1B") | (temp == "1")) {
    return (41)
  } else if (as.numeric(temp) > 40) {
    return (41)
  } else return (as.numeric(temp))
}
MELD_mod("Status 1A"); MELD_mod("MELD/PELD 21")

unique(wl1$CAN_INIT_STAT_desp)

wl1$MELD = sapply(wl1$CAN_INIT_STAT_desp, function(x) {MELD_mod(x)})
#table(wl1$MELD)
```

```{r}
temp = data.table(wl1)[, list(list_mean_MELD = mean(MELD)), by = list(CAN_OPO_CD, CAN_OPO_REGION, policy)]
write.xlsx(temp, "/Volumes/GoogleDrive/My Drive/SRTR/Analysis/cand_INIT_MELD_sum.xlsx", sheetName="Sheet1")
```


Follow-up data exploration:
```{r}
names(txf)
uniqueN(txf$TRR_FOL_ID); uniqueN(txf$TRR_ID); uniqueN(txf$PX_ID); uniqueN(txf$TX_ID)

unique(txf$REC_OPO_ID); unique(txf$REC_CTR_ID)
```

```{r}
# Linking with INSTITUTION data:
inst = read.csv("/Volumes/GoogleDrive/My Drive/SRTR/From SRTR/pubsaf1903/institution.csv")

temp = inst[, c("CTR_ID", "CTR_CD", "CTR_TY", "REGION")] 
colnames(temp) = c("CTR_ID", "REC_OPO_CD", "REC_OPO_TY", "REC_OPO_REGION")
txf = merge(txf, temp, by.x = "REC_OPO_ID", by.y = "CTR_ID", all.x = T)

colnames(temp) = c("CTR_ID", "REC_CTR_CD", "REC_CTR_TY", "REC_CTR_REGION")
txf = merge(txf, temp, by.x = "REC_CTR_ID", by.y = "CTR_ID", all.x = T)
```

```{r}
unique(txf$TFL_FAIL_DT)
table(txf$TFL_GRAFT_STAT)
# temp = txf1[, c("PX_ID", "REC_TX_DT", "TFL_FAIL_DT", "TFL_GRAFT_STAT")]
```

```{r}
txf$REC_TX_DT = as.Date(txf$REC_TX_DT, format= "%Y-%m-%d")
min(txf$REC_TX_DT); max(txf$REC_TX_DT)

# txf1 consists of records whose transplant took place after 2010, and before 2018: 
txf1 = txf[(txf$REC_TX_DT > "2010-01-01") & (txf$REC_TX_DT < "2018-01-01"), ]
txf1$policy = sapply(c(1:nrow(txf1)), function(i) {if (txf1$REC_TX_DT[i] > "2013-06-17") {return ("post")} else {return ("pre")}}) 
```


```{r}
txf1$TFL_FAIL_DT = as.Date(txf1$TFL_FAIL_DT, format= "%Y-%m-%d")
unique(txf1$TFL_FAIL_DT)

# txf1$TFL_FAIL_DT_pre = txf1$TFL_FAIL_DT
# txf1[(txf1$policy == "pre") & (txf1$TFL_FAIL_DT > "2013-06-30"), "TFL_FAIL_DT_pre"] = "NA"

samp_txf1 = txf1[txf1$PX_ID == 737520, ]

f = function(PX_ID, policy, REC_TX_DT, TFL_FAIL_DT, graft_fail_cnt, surv_time_cal) {
  df = data.frame(col1 = PX_ID, col2 = policy, col3 = REC_TX_DT, col4 = TFL_FAIL_DT)
  # print (unique(df$col2))
  if (df$col2[1] == "pre") {    # Limit the records until June 13 (3.5 yrs from 2010)
    df = df[df$col4 < "2013-06-30", ]
  }
  if (graft_fail_cnt == 1) {
    return(uniqueN(df[!is.na(df$col4), c(1)]))
  }
  if (surv_time_cal == 1) {
    df = df[!is.na(df$col4), ]    # Considering only those patients who died!
    val = mean(df$col4 - df$col3)
  }
}

temp = data.table(txf1)[, list(tx_cnt = uniqueN(PX_ID), death_cnt = f(PX_ID, policy, REC_TX_DT, TFL_FAIL_DT, graft_fail_cnt = 1, surv_time_cal = 0 ), mean_surv = f(PX_ID, policy, REC_TX_DT, TFL_FAIL_DT, graft_fail_cnt = 0, surv_time_cal = 1 )), by = list(REC_OPO_CD, REC_OPO_REGION, policy)]

write.xlsx(temp, "/Volumes/GoogleDrive/My Drive/SRTR/Analysis/txf_sum.xlsx", sheetName="Sheet1")

```

Comparing nos. of offers (PTR_SEQ < 10/20) to DSAs before and after:
```{r}
cond11 = (match_not_B_NA_MATCH_seq$PTR_SEQUENCE_NUM_upd < 11)
cond21 = (match_not_B_NA_MATCH_seq$PTR_SEQUENCE_NUM_upd < 21)
match_not_B_NA_MATCH_seq$PTR_SEQUENCE_NUM_upd
names(match_not_B_NA_MATCH_seq)
```

```{r}
names(wl)
match_not_B_NA_MATCH_seq = merge(match_not_B_NA_MATCH_seq, wl[, c("PX_ID", "CAN_OPO_CD", "CAN_OPO_REGION")], by = "PX_ID", all.x = T)
# SOME PX_ID were not found!...address this later!
nrow(match_not_B_NA_MATCH_seq[is.na(match_not_B_NA_MATCH_seq$CAN_OPO_CD), ])/nrow(match_not_B_NA_MATCH_seq) * 100
```

```{r}
temp_11 = data.table(match_not_B_NA_MATCH_seq[cond11, ])[, list(offer_cnt_11 = .N, accept_cnt_11 = sum(PTR_OFFER_ACPT == "Y")), by = list(policy, CAN_OPO_CD, CAN_OPO_REGION)]
temp_11$accept_rate_11 = temp_11$accept_cnt_11 / temp_11$offer_cnt_11
ggplot(temp_11, mapping = aes(x = CAN_OPO_CD, y = accept_rate_11)) + geom_point(aes(colour=factor(policy), group=factor(policy))) + facet_grid(~ CAN_OPO_REGION)

write.xlsx(temp_11, "/Volumes/GoogleDrive/My Drive/SRTR/Analysis/offer_accept.xlsx", sheetName="cnt_11")
```

```{r}
temp_21 = data.table(match_not_B_NA_MATCH_seq[cond21, ])[, list(offer_cnt_21 = .N, accept_cnt_21 = sum(PTR_OFFER_ACPT == "Y")), by = list(policy, CAN_OPO_CD, CAN_OPO_REGION)]
temp_21$accept_rate_21 = temp_21$accept_cnt_21 / temp_21$offer_cnt_21
ggplot(temp_21, mapping = aes(x = CAN_OPO_CD, y = accept_rate_21)) + geom_point(aes(colour=factor(policy), group=factor(policy))) + facet_grid(~ CAN_OPO_REGION)
sum(temp_21$accept_cnt_21) - sum(temp_11$accept_cnt_11)

write.csv(temp_21, "/Volumes/GoogleDrive/My Drive/SRTR/Analysis/offer_acceptd.csv")
```

Comparing nos. of offers (to >= /<  MELD35 patients) at the level of DSAs before and after:
```{r}
names(match_not_B_NA_MATCH_seq)
temp1 = match_not_B_NA_MATCH_seq[!(match_not_B_NA_MATCH_seq$PTR_STAT_CD_desp %in% rem_MELD), ]
temp1$MELD = sapply(temp1$PTR_STAT_CD_desp, function(x) {MELD_mod(x)})

cond = (temp1$MELD >= 35)
temp = data.table(temp1[!cond, ])[, list(offer_cnt_MELD_abv_35 = .N, accept_cnt_MELD_abv_35 = sum(PTR_OFFER_ACPT == "Y")), by = list(policy, CAN_OPO_CD, CAN_OPO_REGION)]
write.csv(temp, "/Volumes/GoogleDrive/My Drive/SRTR/Analysis/temp.csv")
```

Comparing the MELD of accepted offers
```{r}
cond1 = (temp1$PTR_OFFER_ACPT == "Y")
cond = (temp1$MELD >= 35)
temp = data.table(temp1[cond & (temp1$MELD < 35), ])[, list(avg_MELD = mean(MELD)), by = list(policy, CAN_OPO_CD, CAN_OPO_REGION)]
ggplot(temp, mapping = aes(x = CAN_OPO_CD, y = avg_MELD)) + geom_point(aes(colour=factor(policy), group=factor(policy))) + facet_grid(~ CAN_OPO_REGION)
write.csv(temp, "/Volumes/GoogleDrive/My Drive/SRTR/Analysis/temp.csv")
```

